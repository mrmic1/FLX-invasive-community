---
title: "Fluoxetine mesocosm experiment"
output:
  pdf_document: default
  html_notebook: default
editor_options: 
  chunk_output_type: console
---

```{r Load libraries, message = FALSE, warning = FALSE, echo = FALSE}
pacman::p_load( 'rstan', 'brms','tidybayes', 'dplyr','bayesplot', 'rstanarm', 
                'kableExtra', 'patchwork', 'loo', 'emmeans', 'broom', 'broom.mixed', 'cmdstanr',
                'GGally', 'MetBrewer', 'rcartocolor', 'ggrepel', 'devEMF', 'flextable', 'officer',
                'grid', 'readxl', 'tidyverse', 'ggokabeito', 'smatr')

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")

#SET ON PC ONLY
set_cmdstan_path("C:/Users/msmi0005/AppData/Local/R/win-library/4.3/cmdstan-2.32.2")

```

```{r set global parameters, setup, include=FALSE}
knitr::opts_knit$set(
  root.dir = "C:/Users/msmi0005/Documents/FLX_mosquitofish_mesocosm",
  #root.dir = "/Users/marcusmichelangeli/Desktop/FLX_mosquitofish_mesocosm/",
  warning = FALSE,
  message = FALSE)

#color scheme used
Johnson = c("#f6c200","#a00e00","#0086a8","#d04e00","#132b69")
```

```{r sum stats function, include = FALSE, echo = FALSE}
#summary statistics function
summary_stats <- function(df, col, group_vars = NULL) {
  
  if (is.null(group_vars)) {
    # calculate statistics for the entire column
    stats <- c(mean(df[[col]], na.rm = TRUE), 
               sd(df[[col]], na.rm = TRUE), 
               sum(!is.na(df[[col]])), 
               sd(df[[col]], na.rm = TRUE) / sqrt(sum(!is.na(df[[col]]))), 
               min(df[[col]], na.rm = TRUE), 
               max(df[[col]], na.rm = TRUE))
    colnames(stats) <- c("Mean", "SD", "Sample Size", "SE", "Min", "Max")
    return(stats)
  }
  
  # group by one or more variables
  group_df <- df %>% group_by(across(all_of(group_vars)))
  
  stats <- group_df %>% 
    summarize(Mean = mean(!!sym(col), na.rm = TRUE), 
              SD = sd(!!sym(col), na.rm = TRUE), 
              Sample_Size = sum(!is.na(!!sym(col))), 
              SE = SD / sqrt(Sample_Size),
              Min = min(!!sym(col), na.rm = TRUE),
              Max = max(!!sym(col), na.rm = TRUE))
  
  return(stats)
}
```

```{r set table plotting parameters, echo = FALSE}
#set table plotting parameters
set_flextable_defaults(
  font.color = "black",
  border.color = "black",
  font.family = 'Arial',
  line_spacing = 1
  )
```

```{r Set path directories, echo = FALSE}
#set file path
data_path = "./data/"

#set save model path
model_path = "./analysis/models/"

#set graphing path
figure_path = "./analysis/figures/"

#set table path
table_path = "./analysis/tables/"
```

# 1. Fish body size

```{r Load in the fishs size data, echo = FALSE}
fish_dat <- readRDS(paste0(data_path, "fish_size_data.rds"))
```

```{r fish length and weight histograms, fig.align='center', echo = FALSE}
ggplot(fish_dat, aes(x = Length)) +
  geom_histogram(binwidth = 1, color = 'black', fill = 'goldenrod') +
  labs(x = "Body length", y  = "Count",
       title = "Histogram of fish body lengths") +
  theme_bw()

ggplot(fish_dat, aes(x = Weight)) +
  geom_histogram(binwidth = 0.01, color = 'black', fill = 'goldenrod') +
  labs(x = "Body weight", y  = "Count",
       title = "Histogram of fish body weights") +
  theme_bw()
```

```{r Fish length and weight sum stats TABLE, echo = FALSE, include = FALSE}
len.sum.stats = summary_stats(fish_dat, "Length", c("Stage", "Treatment"))
wght.sum.stats = summary_stats(fish_dat, "Weight", c("Stage", "Treatment"))

size.sum.stats = rbind(
  cbind(len.sum.stats, 
        data.frame(Size_metric = "Length")),
  cbind(wght.sum.stats, 
        data.frame(Size_metric = "Weight"))
)

#use flextable to create a table in a word document  
size.sum.stats = 
  size.sum.stats %>% 
  mutate_if(is.numeric, round, 2)

(fish_size_table = 
    qflextable(size.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(fish_size_table, path = paste0(table_path, "fish_size_table.docx"))
```

### 1.1. Fish length

```{r LENGTH: modelling, echo = FALSE, cache = TRUE}
fish_length_gaus_model.brm = 
  bf(Length ~ 1 + Treatment * Stage + (1|Mesocosm))

#run model
fish_length_gaus.model = 
  brm(
    fish_length_gaus_model.brm, 
    data = fish_dat, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'fish_length_gaus.model'),
    file_refit = getOption(paste0(model_path, 'fish_length_gaus.model'), 'on_change'))

#posterior predictive check with pp_check. 
pp_check(fish_length_gaus.model, ndraws = 100) 

#pp_check(HRsize_full_studentT.model, ndraws = 100) #student-t estimates more negative values
pp_check(fish_length_gaus.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(fish_length_gaus.model, prob = 0.95)

#conditional effects
length_cond.plots = plot(conditional_effects(fish_length_gaus.model), plot = F)
weight_cond.plots$Treatment
length_cond.plots$Stage
length_cond.plots$`Treatment:Stage`

```

```{r LENGTH, table of model coefficients, include = FALSE, echo = FALSE}
#extract summary table from brms
fish_length_b_params <- 
  summary(fish_length_gaus.model, prob = 0.95)$fixed 

(fish_length_b_params <- 
    rownames_to_column(fish_length_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(fish_length_model_table = 
    qflextable(fish_length_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Post)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low): Stage (Post)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High): Stage (Post)'))))

save_as_docx(fish_length_model_table, 
             path = paste0(table_path, "fish_length_model_table.docx"))
```


```{r LENGTH planned comparisons, echo = FALSE}
#Differences between stages for each treatment
length.emm <- emmeans(fish_length_gaus.model, ~ Treatment|Stage)
contrast(length.emm, list('Control vs. Low' = c(1, -1, 0),
                        'Control vs. High ' = c(1, 0, -1),
                        'Low vs. High ' = c(0, 1, -1)))

length.emm <- emmeans(fish_length_gaus.model, ~ Stage|Treatment)
contrast(length.emm, list('Pre vs. Post' = c(-1, 1)))
```

```{r LENGTH: stage contrasts model predictions, echo = FALSE}
#Calculate difference (both absolute and percentage change) in fish length before and after mesocosm experiment. 

#Control
control_length_draws <- 
  fish_length_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

control_length_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)


#Low
low_length_draws <- 
  fish_length_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

low_length_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)

#High
high_length_draws <- 
  fish_length_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

high_length_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)


#combined
length_treat_draws <- 
  rbind(
    cbind(control_length_draws, data.frame(Treatment = 'Control')),
    cbind(low_length_draws, data.frame(Treatment = 'Low')),
    cbind(high_length_draws, data.frame(Treatment = 'High')))

length_treat_draws$Treatment <- 
  factor(length_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

```

```{r LENGTH: compare effect size change between stages among treatments, echo = FALSE}
#control v low comp
  length_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  length_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  length_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)
```


```{r LENGTH model predictions, echo = FALSE}
#extract the posterior predictions for our counterfactual datasets
#Control
pred_size_control <- fish_length_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Control',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  group_by(Stage,.draw) 
  mean_qi(.width = c(0.95))

#Low
pred_size_low <- fish_length_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Low',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  mean_qi(.width = c(0.95))

#High
pred_size_high <- fish_length_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'High',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  mean_qi(.width = c(0.95))

size_preds = rbind(
  pred_size_control,
  pred_size_low,
  pred_size_high) 
```

```{r LENGTH plot, echo = FALSE, fig.align = 'center'}
(length.figure = 
   ggplot(data = size_preds, 
          aes (x = Treatment, y = .epred, 
               fill = Stage, color = Stage, group = Stage, shape = Stage)) +
    geom_errorbar(aes(ymin = .lower, ymax = .upper),
                 position = position_dodge(0.9),
                 width = 0.4)+
   geom_jitter(data = fish_dat, 
               aes(x = Treatment, y = Length),
               position = position_jitterdodge(0.3),
               size = 1.5,
               alpha = 0.5) +
    geom_point(position = position_dodge(0.9),
              size = 4,
              fill = 'white') +
   labs(y = 'Fish body length (mm)', 
        x = '') +
   theme_minimal()  +
   scale_color_manual(values = c('#111111', '#777777'))+
   scale_fill_manual(values = c('#111111', '#777777'))+
   scale_shape_manual(values = c(21,22)) +
   theme(legend.position = 'none',
         panel.grid.minor = element_blank(),
         #panel.grid.major = element_blank(),
         axis.text.x = element_text(size = 12),
         axis.text.y = element_text(size = 10),
         axis.title.y = element_text(size = 12)))
```

### 1.2. Fish weight

```{r WEIGHT: modelling, echo = FALSE, cache = TRUE}
fish_weight_gaus_model.brm = 
  bf(Weight ~ 1 + Treatment * Stage + (1|Mesocosm))

#run model
fish_weight_gaus.model = 
  brm(
    fish_weight_gaus_model.brm, 
    data = fish_dat, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'fish_weight_gaus.model'),
    file_refit = getOption(paste0(model_path, 'fish_weight_gaus.model'), 'on_change'))

#posterior predictive check with pp_check. 
pp_check(fish_weight_gaus.model, ndraws = 100) 

#pp_check(HRsize_full_studentT.model, ndraws = 100) #student-t estimates more negative values
pp_check(fish_weight_gaus.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(fish_weight_gaus.model, prob = 0.95) #fish in general were heavier post-Treatment
```

```{r WEIGHT: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
fish_weight_b_params <- 
  summary(fish_weight_gaus.model, prob = 0.95)$fixed 

(fish_weight_b_params <- 
    rownames_to_column(fish_weight_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 4) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(fish_weight_model_table = 
    qflextable(fish_weight_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Post)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low): Stage (Post)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High): Stage (Post)'))))

save_as_docx(fish_weight_model_table, 
             path = paste0(table_path, "fish_weight_model_table.docx"))
```

```{r WEIGHT planned comparisons, echo = FALSE}
#Differences between stages for each treatment
weight.emm <- emmeans(fish_weight_gaus.model, ~ Treatment|Stage)
contrast(weight.emm, list('Control vs. Low' = c(1, -1, 0),
                        'Control vs. High ' = c(1, 0, -1),
                        'Low vs. High ' = c(0, 1, -1)))
```

```{r WEIGHT: stage contrasts model predictions, echo = FALSE}
#Calculate difference (both absolute and percentage change) in fish weight before and after mesocosm experiment. 

#Control
control_weight_draws <- 
  fish_weight_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

control_weight_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)


#Low
low_weight_draws <- 
  fish_weight_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

low_weight_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)

#High
high_weight_draws <- 
  fish_weight_gaus.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  gather_emmeans_draws() 

high_weight_draws %>% 
  pivot_wider(names_from = 'Stage',
                       values_from = .value) %>% 
  rename(Pre_treatment = `Pre-treatment`,
         Post_treatment = `Post-treatment`) %>% 
  mutate(diff = as.numeric(Post_treatment - Pre_treatment)) %>% 
  mutate(perc_diff = as.numeric(diff/Pre_treatment * 100)) %>% 
  select(-Pre_treatment, -Post_treatment) %>% 
  pivot_longer(
    cols = c('diff', 'perc_diff'),
    names_to = 'comp',
    values_to = '.epred') %>% 
  group_by(comp) %>% 
  mean_hdi(.width = 0.95)


#combined
weight_treat_draws <- 
  rbind(
    cbind(control_weight_draws, data.frame(Treatment = 'Control')),
    cbind(low_weight_draws, data.frame(Treatment = 'Low')),
    cbind(high_weight_draws, data.frame(Treatment = 'High')))

weight_treat_draws$Treatment <- 
  factor(weight_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

```

```{r WEIGHT model predictions, echo = FALSE}
#Control
pred_wght_control <- fish_weight_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Control',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  mean_qi(.width = c(0.95))

#Low
pred_wght_low <- fish_weight_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Low',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  mean_qi(.width = c(0.95))

#High
pred_wght_high <- fish_weight_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'High',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>% 
  mean_qi(.width = c(0.95))

wght_preds = rbind(
  pred_wght_control,
  pred_wght_low,
  pred_wght_high) 
```

```{r WEIGHT plot, echo = FALSE, fig.align = 'center'}
(weight.figure = 
   ggplot(data = wght_preds, 
          aes (x = Treatment, y = .epred, 
               fill = Stage, color = Stage, group = Stage, shape = Stage)) +
    geom_errorbar(aes(ymin = .lower, ymax = .upper),
                 position = position_dodge(0.9),
                 width = 0.4)+
   geom_jitter(data = fish_dat, 
               aes(x = Treatment, y = Weight),
               position = position_jitterdodge(0.3),
               size = 1.5,
               alpha = 0.5) +
    geom_point(position = position_dodge(0.9),
              size = 4,
              fill = 'white') +
   labs(y = 'Fish body weight (g)', 
        x = '') +
   theme_classic()  +
   scale_color_manual(values = c('#111111', '#777777'))+
   scale_fill_manual(values = c('#111111', '#777777'))+
   scale_shape_manual(values = c(21,22)) +
   theme(legend.position = 'none',
         panel.grid.minor = element_blank(),
         #panel.grid.major = element_blank(),
         axis.text.x = element_text(size = 12),
         axis.text.y = element_text(size = 10),
         axis.title.y = element_text(size = 12)))

```


# 1.3. Body condition

As a proxy for body condition, I will calculate a scaled mass index. Specifically, I will performe a standard major axis regression (SMA) on log body mass and log body length (sma function, smatr package), and calculated the beta coefficient, which will then be used (with mean body length) to obtain the scaled mass for each fish (Peig and Green, 2009)

Standardised majoraxis (SMA) regression (also known as RMA or reducedmajor axis).

scaled mass index: Ë†Mi = Mi[(L0/Li)^beta(sma)]

```{r}
condtion.index.sma <- smatr::sma(log(Weight) ~ log(Length), fish_dat)
coefs <- coef(condtion.index.sma)
beta <- coefs[2]
mean.length <- mean(fish_dat$Length, na.rm = TRUE)
beta
```

```{r}
fish_dat$scaled.mass.index <- 
  fish_dat$Weight*((mean.length/fish_dat$Length)^beta)
```

```{r Fish body condition sum stats TABLE, echo = FALSE, include = FALSE}
bod_cond.sum.stats = summary_stats(fish_dat, "scaled.mass.index", c("Stage", "Treatment"))

#use flextable to create a table in a word document  
bod_cond.sum.stats = 
  bod_cond.sum.stats %>% 
  mutate_if(is.numeric, round, 3)

(bod_cond_table = 
    qflextable(bod_cond.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(bod_cond_table, path = paste0(table_path, "bod_cond_table.docx"))
```

```{r BODY COND: modelling}
fish_cond_gaus_model.brm = 
  bf(scaled.mass.index ~ 1 + Treatment * Stage + (1|Mesocosm))

#set prior
fish_cond.prior = prior = c(
  set_prior("normal(0, 1)", class = "Intercept"),
  set_prior("normal(0, 0.5)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
fish_cond_gaus.model = 
  brm(
    fish_cond_gaus_model.brm, 
    data = fish_dat, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    prior = fish_cond.prior,
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'fish_cond_gaus.model'),
    file_refit = getOption(paste0(model_path, 'fish_cond_gaus.model'), 'on_change'))

#posterior phhredictive check with pp_check. 
pp_check(fish_cond_gaus.model, ndraws = 100) 

#summary of full model 
summary(fish_cond_gaus.model, prob = 0.95) 
```

```{r BODY COND: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
fish_cond_b_params <- 
  summary(fish_cond_gaus.model, prob = 0.95)$fixed 

(fish_cond_b_params <- 
    rownames_to_column(fish_cond_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 4) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(fish_body_cond_model_table = 
    qflextable(fish_cond_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Post)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low): Stage (Post)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High): Stage (Post)'))))

save_as_docx(fish_body_cond_model_table, 
             path = paste0(table_path, "fish_body_cond_model_table.docx"))
```


```{r BODY COND planned comparisons, echo = FALSE}
#Differences between stages for each treatment
(cond.emm <- emmeans(fish_cond_gaus.model, ~ Treatment|Stage))
(contrast(cond.emm, list('Control vs. Low' = c(1, -1, 0),
                        'Control vs. High ' = c(1, 0, -1),
                        'Low vs. High ' = c(0, 1, -1))))

(cond.emm2 <- emmeans(fish_cond_gaus.model, ~ Stage|Treatment))
(contrast(cond.emm2, list('Pre vs. Post' = c(1, -1))))
```

```{r BODY COND model predictions, echo = FALSE}
#Control
pred_body_cond_control <- 
  fish_cond_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Control',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>%
  mean_qi(.width = c(0.95))

#Low
pred_body_cond_low <- 
  fish_cond_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'Low',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>%
  mean_qi(.width = c(0.95))

#High
pred_body_cond_high <- 
  fish_cond_gaus.model %>% 
  epred_draws(
    newdata = 
      expand.grid(Treatment = 'High',
                  Stage = c('Pre-treatment', 'Post-treatment'),
                  Mesocosm = NA),
    re_formula = NA) %>%
  mean_qi(.width = c(0.95))

body_cond_preds = rbind(
  pred_body_cond_control,
  pred_body_cond_low,
  pred_body_cond_high) 
```

```{r BODY COND plot, echo = FALSE, fig.align = 'center'}
(body_cond.figure = 
   ggplot(data = body_cond_preds, 
          aes (x = Treatment, y = .epred, 
               fill = Stage, color = Stage, group = Stage, shape = Stage)) +
   geom_errorbar(aes(ymin = .lower, ymax = .upper),
                position = position_dodge(0.9),
                width = 0.4)+
   geom_jitter(data = fish_dat,
               aes(x = Treatment, y = scaled.mass.index),
               position = position_jitterdodge(0.3),
               size = 1.5,
               alpha = 0.5) +
    geom_point(position = position_dodge(0.9),
              size = 4,
              fill = 'white') +
   labs(y = 'Body condition (mass scaled index)', 
        x = '') +
   theme_classic()  +
   scale_color_manual(values = c('#111111', '#777777'))+
   scale_fill_manual(values = c('#111111', '#777777'))+
   scale_shape_manual(values = c(21,22)) +
   theme(#legend.position = 'none',
         panel.grid.minor = element_blank(),
         #panel.grid.major = element_blank(),
         axis.text.x = element_text(size = 12),
         axis.text.y = element_text(size = 10),
         axis.title.y = element_text(size = 12)))

```

```{r SAVE body length/weight FIGURE, include = FALSE}
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

glegend = g_legend(body_cond.figure)

plot(glegend)
ggsave(
  glegend,
  filename = paste0(figure_path, "weight_bodycond.legend.pdf"), 
  width = 40,
  height = 20,
  units = 'mm',
  device = 'pdf')

#remove legend from dist plot
body_cond.figure = body_cond.figure + theme(legend.position = "none")

#use patchwork to combine the weight and length figure
weight.figure + body_cond.figure + plot_annotation(tag_levels = c('A', 'B'))

ggsave(
  filename = paste0(figure_path, "weight_bodycond.figure.pdf"), 
  width = 210,
  height = 100,
  units = 'mm',
  device = 'pdf')

```

# 2. Biofilm primary productivity

## Processing 

```{r Load in algae data, echo = FALSE}
alg_dat <- readRDS(paste0(data_path, "biofilm_algae_data.rds"))
```

```{r ALG processing, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
alg_dat_avg <- alg_dat %>%
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    GPP_treat_avg = mean(GPP, na.rm = T),
    GPP_treat_se = sd(GPP, na.rm = T)/sqrt(n()),
    Chl_a_treat_avg = mean(Chl_a, na.rm = T),
    Chl_a_treat_se = sd(Chl_a, na.rm = T)/sqrt(n())
         )

#I am also going to remove the first sampling period as it is not needed for the analysis 
alg_dat_filt <- alg_dat %>% 
  filter(!Sample_date == 1)

#For community respiration we don't have any data for the establishment stage
#Therefore I am going to make a subset of the data just for analysing CR where the Establishment stage is removed
#There is also an outlier point (maybe a mistake in data entry) that I am going to remove

alg_dat_filt_CR <- alg_dat_filt %>% 
  filter(!Stage == 'Establishment') %>% 
  filter(!Sample_ID == 'T2R_6')

#for plotting purposes
alg_dat_avg_CR <- 
  alg_dat %>%
  filter(!Stage == 'Establishment') %>% 
  filter(!Sample_ID == 'T2R_6') %>% 
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    CR_treat_avg = mean(CR, na.rm = T),
    CR_treat_se = sd(CR, na.rm = T)/sqrt(n()))
```

```{r GPP CHLA CR Data exploration, fig.align='center'}
#histogram of GPP (tile only) - Note that GPP equals net primary productivity + community respiration. Apparently, most studies only report GPP.
alg_dat %>%
  ggplot(aes(x = GPP)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
  
#histogram of Chl_a
alg_dat %>% 
  ggplot(aes(x = log(Chl_a))) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

#histogram of CR
alg_dat %>% 
  ggplot(aes(x = CR)) +
  geom_histogram(color = 'black', fill = 'goldenrod')+
  theme_bw()
#a weird outlier value
```

```{r GPP CHL_A CR summary stats TABLE, echo = FALSE, include = FALSE}
GPP.sum.stats = summary_stats(alg_dat_filt, "GPP", c("Treatment", "Stage"))
chla.sum.stats = summary_stats(alg_dat_filt, "Chl_a", c("Treatment", "Stage"))
CR.sum.stats = summary_stats(alg_dat_filt_CR, "CR", c("Stage", "Treatment"))

#use flextable to create a table in a word document
#CHL_A
chla.sum.stats = 
  chla.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(chla_table = 
    qflextable(chla.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(chla_table, path = paste0(table_path, "chla_table.docx"))

#GPP
GPP.sum.stats = 
  GPP.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(GPP_table = 
    qflextable(GPP.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(GPP_table, path = paste0(table_path, "GPP_table.docx"))

#CR
CR.sum.stats = 
  CR.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(CR_alg_table = 
    qflextable(CR.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(CR_alg_table, path = paste0(table_path, "CR_alg_table.docx"))
```

### 2.1 Chlorophyll a

```{r CHL_A: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 10, sd = 5)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd = 1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.3)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "chlorophyll a") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r CHL_A: modelling, echo = FALSE, cache = TRUE}
chla_full_model.brm = 
  bf(Chl_a_avg ~ Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
chla.prior = prior = c(
  set_prior("normal(5, 3)", class = "Intercept"),
  set_prior("normal(0, 1)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
water_chla_full.model = 
  brm(
    chla_full_model.brm, 
    data = alg_dat_filt,
    prior = chla.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'water_chla_full.model_test'),
    file_refit = getOption(paste0(model_path, 'water_chla_full.model_test'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(water_chla_full.model, ndraws = 100) #a little skewed

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(water_chla_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(water_chla_full.model, prob = 0.95)

#Conditional effects 
chla_stage_cond_eff = plot(conditional_effects(water_chla_full.model), plot = F)
chla_stage_cond_eff$Treatment
chla_stage_cond_eff$Stage
chla_stage_cond_eff$Avg_length_std
chla_stage_cond_eff$`Stage:Treatment`

#add waic and loo criterion
water_chla_full.model <- 
  add_criterion(
    water_chla_full.model, c('waic', 'loo'), 
    moment_match = T, overwrite = T, 
    file = paste0(model_path, 'water_chla_full.model'))
```

```{r CHL_A: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
chla_b_params <- 
  summary(water_chla_full.model, prob = 0.95)$fixed 

(chla_b_params <- 
    rownames_to_column(chla_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(chla_model_table = 
    qflextable(chla_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(chla_model_table, 
             path = paste0(table_path, "chla_model_table.docx"))
```

```{r CHL_A: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(chla.stage.emm <- emmeans(water_chla_full.model, ~ Stage|Treatment, type = 'response'))
(chla.stage.cont = 
  as.data.frame(
    contrast(chla.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0,-1, 0, 1)))))

(chla.stage.emm_filt <- as.data.frame(chla.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean)) 

#need to add the values for Fish only stage again, for final contrast calculation
(replicate_rows <- chla.stage.emm_filt %>%
  filter(row_number() %in% c(2,5,8)))
(chla.stage.emm_filt <- rbind(chla.stage.emm_filt, replicate_rows))

#Need to swap rows for calculation to work
(chla.stage.emm_filt <- chla.stage.emm_filt %>% 
  slice(c(1:3,10,4:6,11,7:9,12)))

#combine
(chla.stage.cont_sum <- 
  cbind(chla.stage.cont, chla.stage.emm_filt))

(chla.stage.cont_sum <-  
  chla.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

#Difference between treatments at each stage
(chla_treat.emm <- emmeans(water_chla_full.model, ~ Treatment|Stage))
(chla.treat.cont <- 
  as.data.frame(
  contrast(
    chla_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))))

(chla_treat.emm_filt <- as.data.frame(chla_treat.emm)  %>% 
  select(emmean))

(chla.treat.cont <- 
  cbind(chla.treat.cont, chla_treat.emm_filt))

(chla.treat.cont <-  
  chla.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

```

```{r CHL_A: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

low_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

high_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

chla_treat_draws <- 
  rbind(
    cbind(control_chla_draws, data.frame(Treatment = 'Control')),
    cbind(low_chla_draws, data.frame(Treatment = 'Low')),
    cbind(high_chla_draws, data.frame(Treatment = 'High')))

chla_treat_draws$Treatment <- 
  factor(chla_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r CHL_A: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Establishment
estab_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
chla_stage_draws <- 
  rbind(
    cbind(estab_chla_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_chla_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_chla_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_chla_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


chla_stage_draws$Stage <- 
  factor(chla_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

chla_stage_draws$contrast <- factor(chla_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

chla_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  mean_hdi()


#plot
(chla_stage_marg_fig <- 
    ggplot(chla_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    xlim(-4, 4) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r CHL_A marginal effects FIGURE, include = FALSE}
ggsave(
  filename = paste0(figure_path, "chla_stage_marg_fig.emf"), 
  width = 210,
  height = 150,
  units = 'mm',
  device = {\(filename, ...) devEMF::emf(file = filename, ...)})
```

```{r CHL_A: FIGURE, echo = FALSE, fig.align='center', fig.cap = 'Chlorophyll a concentration in mesocsoms over time }
(chla_figure = 
    ggplot(
      data = alg_dat_avg, 
      aes(x = Sample_date, y = Chl_a_treat_avg, 
          group = Treatment, shape = Treatment)) +
    #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
    geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
    geom_errorbar(
      aes(ymin = Chl_a_treat_avg - Chl_a_treat_se, 
          ymax = Chl_a_treat_avg + Chl_a_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
    # geom_jitter(
    #   data = alg_dat_filt, aes(x = Sample_date, y = Chl_a_avg, group = Treatment),
    #             position = position_jitter(0.15),
    #             alpha = 0.3,
    #             size = 2,
    #             fill = 'black') +
    geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
    labs(y = expression("Chlorophyll a" ~ (mg/m^2)), 
         x = '') +
    theme_classic() +
    scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(alg_dat$Sample_date))+
    guides(shape = guide_legend(override.aes = 
                                  list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

```{r CHL_A MS FIGURE, include = FALSE}
(CHLA_figs <- chla_figure + chla_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "CHLA_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```


### 2.2. GPP

```{r GPP: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 20, sd = 5)) %>% 
  mutate(`beta%~%Normal(0*', '*10)`  = rnorm(100, mean = 0 , sd = 10),
         `beta%~%Normal(0*', '*5)` = rnorm(100, mean = 0 , sd = 5),
         `beta%~%Normal(0*', '*2)` = rnorm(100, mean = 0 , sd = 2)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "chlorophyll a") +
  coord_cartesian(ylim = c(-10, 75)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r GPP: modelling, echo = FALSE, cache = TRUE}
GPP_full_model.brm = 
  bf(GPP_avg ~ 1 + Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
GPP.prior = prior = c(
  set_prior("normal(10,5)", class = "Intercept"),
  set_prior("normal(0, 10)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
GPP_full.model = 
  brm(
    GPP_full_model.brm, 
    data = alg_dat_filt, 
    prior = GPP.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'GPP_full.model'),
    file_refit = getOption(paste0(model_path, 'GPP_full.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(GPP_full.model, ndraws = 100) #a little skewed

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(GPP_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(GPP_full.model, prob = 0.95)

#Conditional effects 
GPP_cond_eff = plot(conditional_effects(GPP_full.model), plot = F)
GPP_cond_eff$Treatment
GPP_cond_eff$Stage
GPP_cond_eff$Avg_length_std
GPP_cond_eff$Sample_date
GPP_cond_eff$`Stage:Treatment`

#add waic and loo criterion 
GPP_full.model <- 
  add_criterion(
    GPP_full.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'GPP_full.model'))
```

```{r GPP: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
GPP_b_params <- 
  summary(GPP_full.model, prob = 0.95)$fixed 

(GPP_b_params <- 
    rownames_to_column(GPP_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(GPP_model_table = 
    qflextable(GPP_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(GPP_model_table, 
             path = paste0(table_path, "GPP_model_table.docx"))
```

```{r GPP: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(GPP.stage.emm <- emmeans(GPP_full.model, ~ Stage|Treatment))
(GPP.stage.cont = 
  as.data.frame(
    contrast(GPP.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0,-1, 0,1)))))

(GPP.stage.emm_filt <- as.data.frame(GPP.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean)) 

#need to add the values for Fish only stage again, for final contrast calculation
(replicate_rows <- GPP.stage.emm_filt %>%
  filter(row_number() %in% c(2,5,8)))
(GPP.stage.emm_filt <- rbind(GPP.stage.emm_filt, replicate_rows))

#Need to swap rows for calculation to work
(GPP.stage.emm_filt <- GPP.stage.emm_filt %>% 
  slice(c(1:3,10,4:6,11,7:9,12)))

#combine
(GPP.stage.cont_sum <- 
  cbind(GPP.stage.cont, GPP.stage.emm_filt))

(GPP.stage.cont_sum <-  
  GPP.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

#Difference between treatments at each stage
(GPP_treat.emm <- emmeans(GPP_full.model, ~ Treatment|Stage))
(GPP.treat.cont <- 
  as.data.frame(
  contrast(
    GPP_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))))

GPP_treat.emm <- as.data.frame(GPP_treat.emm)  %>% 
  select(emmean) 

GPP.treat.cont <- 
  cbind(GPP.treat.cont, GPP_treat.emm)

(GPP.treat.cont <-  
  GPP.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

```

```{r GPP: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

low_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

high_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
 contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

GPP_treat_draws <- 
  rbind(
    cbind(control_GPP_draws, data.frame(Treatment = 'Control')),
    cbind(low_GPP_draws, data.frame(Treatment = 'Low')),
    cbind(high_GPP_draws, data.frame(Treatment = 'High')))

GPP_treat_draws$Treatment <- 
  factor(GPP_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r GPP: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Establishment
estab_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_GPP_draws <- GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
GPP_stage_draws <- 
  rbind(
    cbind(estab_GPP_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_GPP_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_GPP_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_GPP_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


GPP_stage_draws$Stage <- 
  factor(GPP_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

GPP_stage_draws$contrast <- factor(GPP_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

GPP_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  median_hdi()


#plot
(GPP_stage_marg_fig <- 
    ggplot(GPP_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r GPP: FIGURE, echo = FALSE, fig.align ='center', fig.cap = 'GPP in mesocosms over time'}
(GPP_figure = 
   ggplot(
     data = alg_dat_avg, 
       aes(x = Sample_date, y = GPP_treat_avg, 
           group = Treatment, shape = Treatment)) +
  #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
  geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
  geom_errorbar(
      aes(ymin = GPP_treat_avg - GPP_treat_se, 
          ymax = GPP_treat_avg + GPP_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
  # geom_jitter(
  #   data = alg_dat_filt, aes(x = Sample_date, y = GPP_avg, 
  #                            group = Treatment),
  #             position = position_jitter(0.15),
  #             alpha = 0.3,
  #             size = 2,
  #             fill = 'black') +
  geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
  labs(y = expression("GPP" ~ (mgO^2/m^2/h)), 
       x = 'Sampling period') +
  theme_classic() +
 scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(alg_dat$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))

```

```{r GPP MS FIGURE, include = FALSE}
(GPP_figs <- GPP_figure + GPP_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "GPP_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```

### 2.3 Community respiration

```{r CR ALG: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 3, sd = 1)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd =1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.3)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "CR") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r CR ALG: modelling, echo = FALSE, cache = TRUE}
CR_alg_full_model.brm = 
  bf(sqrt(CR_avg) ~ Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
CR_alg.prior = prior = c(
  set_prior("normal(3, 1)", class = "Intercept"),
  set_prior("normal(0, 1)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
CR_alg_full.model = 
  brm(
    CR_alg_full_model.brm, 
    data = alg_dat_filt_CR,
    prior = CR_alg.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'CR_alg_full.model'),
    file_refit = getOption(paste0(model_path, 'CR_alg_full.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(CR_alg_full.model, ndraws = 100) 

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(CR_alg_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(CR_alg_full.model, prob = 0.95)

#Conditional effects 
CR_alg_stage_cond_eff = plot(conditional_effects(CR_alg_full.model), plot = F)
CR_alg_stage_cond_eff$Treatment
CR_alg_stage_cond_eff$Stage
CR_alg_stage_cond_eff$Avg_length_std
CR_alg_stage_cond_eff$`Stage:Treatment`

#add waic and loo criterion
CR_alg_full.model <- 
  add_criterion(
    CR_alg_full.model, c('waic', 'loo'), 
    moment_match = T, overwrite = T, 
    file = paste0(model_path, 'CR_alg_full.model'))
```

```{r CR_ALG: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
CR_alg_b_params <- 
  summary(CR_alg_full.model, prob = 0.95)$fixed 

(CR_alg_b_params <- 
    rownames_to_column(CR_alg_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(CR_alg_model_table = 
    qflextable(CR_alg_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(CR_alg_model_table, 
             path = paste0(table_path, "CR_alg_model_table.docx"))
```

```{r CR_ALG: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
CR_alg.stage.emm <- emmeans(CR_alg_full.model, ~ Stage|Treatment, type = "response")
CR_alg.stage.cont = 
  as.data.frame(
    contrast(CR_alg.stage.emm, 
             list('Fish only vs. Fish & Flx ' = c(-1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0, -1, 1))))

CR_alg.stage.emm <- as.data.frame(CR_alg.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean) 

CR_alg.stage.cont <- 
  cbind(CR_alg.stage.cont, CR_alg.stage.emm)

(CR_alg.stage.cont <-  
  CR_alg.stage.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))


#Difference between treatments at each stage
CR_alg_treat.emm <- emmeans(CR_alg_full.model, ~ Treatment|Stage)
CR_alg.treat.cont <- 
  as.data.frame(
  contrast(
    CR_alg_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1))))

CR_alg_treat.emm <- as.data.frame(CR_alg_treat.emm)  %>% 
  select(emmean) 

CR_alg.treat.cont <- 
  cbind(CR_alg.treat.cont, CR_alg_treat.emm)

(CR_alg.treat.cont <-  
  CR_alg.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

```

```{r CR_ALG: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

low_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

high_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

CR_alg_treat_draws <- 
  rbind(
    cbind(control_CR_alg_draws, data.frame(Treatment = 'Control')),
    cbind(low_CR_alg_draws, data.frame(Treatment = 'Low')),
    cbind(high_CR_alg_draws, data.frame(Treatment = 'High')))

CR_alg_treat_draws$Treatment <- 
  factor(CR_alg_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r CR_ALG: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Fish only
fish_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_CR_alg_draws <- CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
CR_alg_stage_draws <- 
  rbind(
    cbind(fish_CR_alg_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_CR_alg_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_CR_alg_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


CR_alg_stage_draws$Stage <- 
  factor(CR_alg_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

CR_alg_stage_draws$contrast <- factor(CR_alg_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

CR_alg_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  median_hdi()


#plot
(CR_alg_stage_marg_fig <- 
    ggplot(CR_alg_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage), nrow = 2) +
    theme_minimal() +
    xlim(-2,2) +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r CR_ALG: plot, echo = FALSE, fig.align ='center'}
(CR_ALG_figure = 
   ggplot(
     data = alg_dat_avg_CR,
       aes(x = Sample_date, y = CR_treat_avg, 
           group = Treatment, shape = Treatment)) +
  #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
  geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
  geom_errorbar(
      aes(ymin = CR_treat_avg - CR_treat_se, 
          ymax = CR_treat_avg + CR_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
  # geom_jitter(
  #   data = alg_dat_filt, aes(x = Sample_date, y = GPP_avg, 
  #                            group = Treatment),
  #             position = position_jitter(0.15),
  #             alpha = 0.3,
  #             size = 2,
  #             fill = 'black') +
  geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
  labs(y = expression("Community respiration" ~ (mgO^2/m^2/h)), 
       x = 'Sampling period') +
  theme_classic() +
 scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(alg_dat_avg_CR$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))


```

```{r CHL_A MS FIGURE, include = FALSE}
(CR_figs <- CR_ALG_figure + CR_alg_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "CR_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```


#3. Water primary productivity

## Pre-processing

```{r Load in water algae data, echo = FALSE}
water_alg_dat <- readRDS(paste0(data_path, "water_algae_data.rds"))
```

```{r WATER ALG processing, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
water_alg_dat_avg <- water_alg_dat %>%
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    GPP_treat_avg = mean(GPP, na.rm = T),
    GPP_treat_se = sd(GPP, na.rm = T)/sqrt(n()),
    Chl_a_treat_avg = mean(Chl_a, na.rm = T),
    Chl_a_treat_se = sd(Chl_a, na.rm = T)/sqrt(n()),
    CR_treat_avg = mean(CR, na.rm = T),
    CR_treat_se = sd(CR, na.rm = T)/sqrt(n()),
         )

#I am also going to remove the first sampling period as it is not needed for the analysis 
water_alg_dat_filt <- water_alg_dat %>% 
  filter(!Sample_date == 1)

#For community respiration we don't have any data for the establishment stage
#Therefore I am going to make a subset of the data just for analysing CR where the Establishment stage is removed

water_alg_dat_filt_CR <- water_alg_dat_filt %>% 
  filter(!Stage == 'Establishment')

#for plotting purposes
water_alg_dat_avg_CR <- 
  water_alg_dat %>%
  filter(!Stage == 'Establishment') %>% 
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    CR_treat_avg = mean(CR, na.rm = T),
    CR_treat_se = sd(CR, na.rm = T)/sqrt(n()))
```

```{r WATER GPP CHLA CR Data exploration, fig.align='center'}
#histogram of GPP (tile only) - Note that GPP equals net primary productivity + community respiration. Apparently, most studies only report GPP.
water_alg_dat %>%
  ggplot(aes(x = GPP)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
  
#histogram of Chl_a
water_alg_dat %>% 
  ggplot(aes(x = log(Chl_a + 1))) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

#histogram of CR
water_alg_dat %>% 
  ggplot(aes(x = sqrt(CR))) +
  geom_histogram(color = 'black', fill = 'goldenrod')+
  theme_bw()
```

```{r WATER GPP CHL_A CR summary stats TABLE, echo = FALSE, include = FALSE}
GPP.sum.stats = summary_stats(water_alg_dat_filt, "GPP", c("Treatment", "Stage"))
chla.sum.stats = summary_stats(water_alg_dat_filt, "Chl_a", c("Treatment", "Stage"))
CR.sum.stats = summary_stats(water_alg_dat_filt_CR, "CR", c("Stage", "Treatment"))

#use flextable to create a table in a word document
#CHL_A
chla.sum.stats = 
  chla.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(chla_table = 
    qflextable(chla.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(chla_table, path = paste0(table_path, "water_chla_table.docx"))

#GPP
GPP.sum.stats = 
  GPP.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(GPP_table = 
    qflextable(GPP.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(GPP_table, path = paste0(table_path, "water_GPP_table.docx"))

#CR
CR.sum.stats = 
  CR.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(CR_alg_table = 
    qflextable(CR.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(CR_alg_table, path = paste0(table_path, "water_CR_alg_table.docx"))
```

### 3.1 WATER Chlorophyll a

```{r WATER CHL_A: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 1, sd = 0.5)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd = 1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.3)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "chlorophyll a") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r WATER CHL_A: modelling, echo = FALSE, cache = TRUE}
water_chla_full_model.brm = 
  bf(Chl_a  ~ Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
water_chla.prior = prior = c(
  set_prior("normal(1, 0.5)", class = "Intercept"),
  set_prior("normal(0, 0.3)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
water_chla_full.model = 
  brm(
    water_chla_full_model.brm, 
    data = water_alg_dat_filt,
    prior = water_chla.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'water_chla_full.model'),
    file_refit = getOption(paste0(model_path, 'water_chla_full.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(water_chla_full.model, ndraws = 100) #a little skewed

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(water_chla_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(water_chla_full.model, prob = 0.95)

#Conditional effects 
water_chla_stage_cond_eff = plot(conditional_effects(water_chla_full.model), plot = F)
water_chla_stage_cond_eff$Treatment
water_chla_stage_cond_eff$Stage
water_chla_stage_cond_eff$Avg_length_std
water_chla_stage_cond_eff$`Stage:Treatment`

#add waic and loo criterion
water_chla_full.model <- 
  add_criterion(
    water_chla_full.model, c('waic', 'loo'), 
    moment_match = T, overwrite = T, 
    file = paste0(model_path, 'water_chla_full.model'))
```

```{r WATER CHL_A: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
water_chla_b_params <- 
  summary(water_chla_full.model, prob = 0.95)$fixed 

(water_chla_b_params <- 
    rownames_to_column(water_chla_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(water_chla_model_table = 
    qflextable(water_chla_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(water_chla_model_table, 
             path = paste0(table_path, "water_chla_model_table.docx"))
```

```{r WATER CHL_A: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(water_chla.stage.emm <- emmeans(water_chla_full.model, ~ Stage|Treatment, type = 'response'))
(water_chla.stage.cont = 
  as.data.frame(
    contrast(water_chla.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0,-1, 0, 1)))))

(water_chla.stage.emm_filt <- as.data.frame(water_chla.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean)) 

#need to add the values for Fish only stage again, for final contrast calculation
(replicate_rows <- water_chla.stage.emm_filt %>%
  filter(row_number() %in% c(2,5,8)))
(water_chla.stage.emm_filt <- rbind(water_chla.stage.emm_filt, replicate_rows))

#Need to swap rows for calculation to work
(water_chla.stage.emm_filt <- water_chla.stage.emm_filt %>% 
  slice(c(1:3,10,4:6,11,7:9,12)))

#combine
(water_chla.stage.cont_sum <- 
  cbind(water_chla.stage.cont, water_chla.stage.emm_filt))

(water_chla.stage.cont_sum <-  
  water_chla.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

#Difference between treatments at each stage
(water_c
  hla_treat.emm <- emmeans(water_chla_full.model,
                                 ~ Treatment|Stage))
(water_chla.treat.cont <- 
  as.data.frame(
  contrast(
    water_chla_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))))

(water_chla_treat.emm_filt <- as.data.frame(water_chla_treat.emm)  %>% 
  select(emmean))

(water_chla.treat.cont <- 
  cbind(water_chla.treat.cont, water_chla_treat.emm_filt))

(water_chla.treat.cont <-  
  water_chla.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

```

```{r WATER CHL_A: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

low_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

high_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)),
    'Fish only vs. Flx only' = c(0, -1, 0, 1)) %>% 
  gather_emmeans_draws()

water_chla_treat_draws <- 
  rbind(
    cbind(control_water_chla_draws, data.frame(Treatment = 'Control')),
    cbind(low_water_chla_draws, data.frame(Treatment = 'Low')),
    cbind(high_water_chla_draws, data.frame(Treatment = 'High')))

water_chla_treat_draws$Treatment <- 
  factor(water_chla_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  water_chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  water_chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  water_chla_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r WATER CHL_A: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Establishment
estab_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_water_chla_draws <- water_chla_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
water_chla_stage_draws <- 
  rbind(
    cbind(estab_water_chla_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_water_chla_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_water_chla_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_water_chla_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


water_chla_stage_draws$Stage <- 
  factor(water_chla_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

water_chla_stage_draws$contrast <- factor(water_chla_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

water_chla_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  mean_hdi()


#plot
(water_chla_stage_marg_fig <- 
    ggplot(water_chla_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    xlim(-0.2, 0.2) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r WATER CHL_A: FIGURE, echo = FALSE, fig.align='center', fig.cap = 'Chlorophyll a concentration in mesocsoms over time }
(water_chla_figure = 
    ggplot(
      data = water_alg_dat_avg, 
      aes(x = Sample_date, y = Chl_a_treat_avg, 
          group = Treatment, shape = Treatment)) +
    #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
    geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
    geom_errorbar(
      aes(ymin = Chl_a_treat_avg - Chl_a_treat_se, 
          ymax = Chl_a_treat_avg + Chl_a_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
    # geom_jitter(
    #   data = alg_dat_filt, aes(x = Sample_date, y = Chl_a_avg, group = Treatment),
    #             position = position_jitter(0.15),
    #             alpha = 0.3,
    #             size = 2,
    #             fill = 'black') +
    geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
    labs(y = expression("Chlorophyll a" ~ (mg/m^2)), 
         x = '') +
    theme_classic() +
    scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(water_alg_dat$Sample_date))+
    guides(shape = guide_legend(override.aes = 
                                  list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

```{r WATER CHL_A MS FIGURE, include = FALSE}
(WATER_CHLA_figs <- water_chla_figure + water_chla_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "WATER_CHLA_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```


### 3.2.WATER GPP

```{r WATER GPP: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 0.5, sd = 0.5)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd = 1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.3)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "chlorophyll a") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r WATER GPP: modelling, echo = FALSE, cache = TRUE}
water_GPP_full_model.brm = 
  bf(GPP ~ 1 + Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
water_GPP.prior = prior = c(
  set_prior("normal(1, 0.5)", class = "Intercept"),
  set_prior("normal(0, 0.3)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
water_GPP_full.model = 
  brm(
    water_GPP_full_model.brm, 
    data = water_alg_dat_filt, 
    prior = water_GPP.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'water_GPP_full.model'),
    file_refit = getOption(paste0(model_path, 'water_GPP_full.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(water_GPP_full.model, ndraws = 100) #looks good

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(water_GPP_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(water_GPP_full.model, prob = 0.95)

#Conditional effects 
water_GPP_cond_eff = plot(conditional_effects(water_GPP_full.model), plot = F)
water_GPP_cond_eff$Treatment
water_GPP_cond_eff$Stage
water_GPP_cond_eff$Avg_length_std
water_GPP_cond_eff$Sample_date
water_GPP_cond_eff$`Stage:Treatment`

#add waic and loo criterion 
water_GPP_full.model <- 
  add_criterion(
    water_GPP_full.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'water_GPP_full.model'))
```

```{r WATER GPP: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
water_GPP_b_params <- 
  summary(water_GPP_full.model, prob = 0.95)$fixed 

(water_GPP_b_params <- 
    rownames_to_column(water_GPP_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(water_GPP_model_table = 
    qflextable(water_GPP_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(water_GPP_model_table, 
             path = paste0(table_path, "water_GPP_model_table.docx"))
```

```{r WATER GPP: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(water_GPP.stage.emm <- emmeans(water_GPP_full.model, ~ Stage|Treatment))
(water_GPP.stage.cont = 
  as.data.frame(
    contrast(water_GPP.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0,-1, 0,1)))))

(water_GPP.stage.emm_filt <- as.data.frame(water_GPP.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean)) 

#need to add the values for Fish only stage again, for final contrast calculation
(replicate_rows <- water_GPP.stage.emm_filt %>%
  filter(row_number() %in% c(2,5,8)))
(water_GPP.stage.emm_filt <- rbind(water_GPP.stage.emm_filt, replicate_rows))

#Need to swap rows for calculation to work
(water_GPP.stage.emm_filt <- water_GPP.stage.emm_filt %>% 
  slice(c(1:3,10,4:6,11,7:9,12)))

#combine
(water_GPP.stage.cont_sum <- 
  cbind(water_GPP.stage.cont, water_GPP.stage.emm_filt))

(water_GPP.stage.cont_sum <-  
  water_GPP.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

#Difference between treatments at each stage
(water_GPP_treat.emm <- emmeans(water_GPP_full.model, ~ Treatment|Stage))
(water_GPP.treat.cont <- 
  as.data.frame(
  contrast(
    water_GPP_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))))

water_GPP_treat.emm <- as.data.frame(water_GPP_treat.emm)  %>% 
  select(emmean) 

water_GPP.treat.cont <- 
  cbind(water_GPP.treat.cont, water_GPP_treat.emm)

(water_GPP.treat.cont <-  
  water_GPP.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))
```

```{r WATER GPP: find whether differences among stage are sig diff between treatment, echo = FALSE}
water_control_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

water_low_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

water_high_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
 contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
    'Fish only vs. Flx only' = c(0,-1, 0, 1))) %>% 
  gather_emmeans_draws()

water_GPP_treat_draws <- 
  rbind(
    cbind(water_control_GPP_draws, data.frame(Treatment = 'Control')),
    cbind(water_low_GPP_draws, data.frame(Treatment = 'Low')),
    cbind(water_high_GPP_draws, data.frame(Treatment = 'High')))

water_GPP_treat_draws$Treatment <- 
  factor(water_GPP_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  water_GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  water_GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  water_GPP_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r WATER GPP: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Establishment
estab_water_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_water_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_water_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_water_GPP_draws <- water_GPP_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
water_GPP_stage_draws <- 
  rbind(
    cbind(estab_water_GPP_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_water_GPP_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_water_GPP_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_water_GPP_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


water_GPP_stage_draws$Stage <- 
  factor(water_GPP_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

water_GPP_stage_draws$contrast <- factor(water_GPP_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

water_GPP_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  median_hdi()


#plot
(water_GPP_stage_marg_fig <- 
    ggplot(water_GPP_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    theme_minimal() +
    xlim(-0.4, 0.4) +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r WATER GPP: FIGURE, echo = FALSE, fig.align ='center', fig.cap = 'GPP in mesocosms over time'}
(water_GPP_figure = 
   ggplot(
     data = water_alg_dat_avg, 
       aes(x = Sample_date, y = GPP_treat_avg, 
           group = Treatment, shape = Treatment)) +
  #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
  geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
  geom_errorbar(
      aes(ymin = GPP_treat_avg - GPP_treat_se, 
          ymax = GPP_treat_avg + GPP_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
  # geom_jitter(
  #   data = alg_dat_filt, aes(x = Sample_date, y = GPP_avg, 
  #                            group = Treatment),
  #             position = position_jitter(0.15),
  #             alpha = 0.3,
  #             size = 2,
  #             fill = 'black') +
  geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
  labs(y = expression("GPP" ~ (mgO^2/m^2/h)), 
       x = 'Sampling period') +
  theme_classic() +
 scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(water_alg_dat$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))

```

```{r WATER GPP MS FIGURE, include = FALSE}
(water_GPP_figs <- water_GPP_figure + water_GPP_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "water_GPP_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```

### 2.3 WATER CR (Community respiration)

```{r WATER CR ALG: prior checks, echo = FALSE}
#GAUSSIAN - 
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 0.5, sd = 0.5)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd = 1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.3)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "CR") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r WATER CR ALG: modelling, echo = FALSE, cache = TRUE}
water_CR_alg_full_model.brm = 
  bf(CR_avg ~ Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

#set prior
water_CR_alg.prior = c(
  set_prior("normal(1, 0.5)", class = "Intercept"),
  set_prior("normal(0, 0.3)", class = "b"),
  set_prior("exponential(1)", class = 'sigma'))

#run model
water_CR_alg_full.model = 
  brm(
    water_CR_alg_full_model.brm, 
    data = water_alg_dat_filt_CR,
    prior = water_CR_alg.prior,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'water_CR_alg_full.model'),
    file_refit = getOption(paste0(model_path, 'water_CR_alg_full.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check with pp_check. 
pp_check(water_CR_alg_full.model, ndraws = 100) 

#pp_check(HRsize_full_studentT.model, ndraws = 100) 
pp_check(water_CR_alg_full.model, type = 'stat', stat = 'mean')

#summary of full model 
summary(water_CR_alg_full.model, prob = 0.95)

#Conditional effects 
water_CR_alg_stage_cond_eff = plot(conditional_effects(water_CR_alg_full.model), plot = F)
water_CR_alg_stage_cond_eff$Treatment
water_CR_alg_stage_cond_eff$Stage
water_CR_alg_stage_cond_eff$Avg_length_std
water_CR_alg_stage_cond_eff$`Stage:Treatment`

#add waic and loo criterion
water_CR_alg_full.model <- 
  add_criterion(
    water_CR_alg_full.model, c('waic', 'loo'), 
    moment_match = T, overwrite = T, 
    file = paste0(model_path, 'water_CR_alg_full.model'))
```

```{r WATER CR_ALG: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
water_CR_alg_b_params <- 
  summary(water_CR_alg_full.model, prob = 0.95)$fixed 

(water_CR_alg_b_params <- 
    rownames_to_column(water_CR_alg_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(water_CR_alg_model_table = 
    qflextable(water_CR_alg_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(water_CR_alg_model_table, 
             path = paste0(table_path, "water_CR_alg_model_table.docx"))
```

```{r WATER CR ALG: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
water_CR_alg.stage.emm <- emmeans(water_CR_alg_full.model, ~ Stage|Treatment, type = "response")
water_CR_alg.stage.cont = 
  as.data.frame(
    contrast(water_CR_alg.stage.emm, 
             list('Fish only vs. Fish & Flx ' = c(-1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0, -1, 1))))

water_CR_alg.stage.emm <- as.data.frame(water_CR_alg.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean) 

water_CR_alg.stage.cont <- 
  cbind(water_CR_alg.stage.cont, water_CR_alg.stage.emm)

(water_CR_alg.stage.cont <-  
  water_CR_alg.stage.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))


#Difference between treatments at each stage
water_CR_alg_treat.emm <- emmeans(water_CR_alg_full.model, ~ Treatment|Stage)
water_CR_alg.treat.cont <- 
  as.data.frame(
  contrast(
    water_CR_alg_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1))))

water_CR_alg_treat.emm <- as.data.frame(water_CR_alg_treat.emm)  %>% 
  select(emmean) 

water_CR_alg.treat.cont <- 
  cbind(water_CR_alg.treat.cont, water_CR_alg_treat.emm)

(water_CR_alg.treat.cont <-  
  water_CR_alg.treat.cont %>% 
  #rescale back to normal values
  #mutate(across(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))

```

```{r WATER CR_ALG: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

low_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

high_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
contrast(list(
    'Fish only vs. Fish & Flx ' = c(-1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,-1, 1))) %>% 
  gather_emmeans_draws()

water_CR_alg_treat_draws <- 
  rbind(
    cbind(control_water_CR_alg_draws, data.frame(Treatment = 'Control')),
    cbind(low_water_CR_alg_draws, data.frame(Treatment = 'Low')),
    cbind(high_water_CR_alg_draws, data.frame(Treatment = 'High')))

water_CR_alg_treat_draws$Treatment <- 
  factor(water_CR_alg_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))

#Now compare effect size changes between stages among treatments

#control v low comp
  water_CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  water_CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  water_CR_alg_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)
```

```{r WATER CR_ALG: find whether differences among treatment are sig diff at different stages, echo = FALSE}
#Fish only
fish_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish_exposure
fish_exp_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_water_CR_alg_draws <- water_CR_alg_full.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(water_alg_dat_filt$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#combined
water_CR_alg_stage_draws <- 
  rbind(
    cbind(fish_water_CR_alg_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_water_CR_alg_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_water_CR_alg_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


water_CR_alg_stage_draws$Stage <- 
  factor(water_CR_alg_stage_draws$Stage,
         levels = c(
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

water_CR_alg_stage_draws$contrast <- factor(water_CR_alg_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

water_CR_alg_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  median_hdi()


#plot
(water_CR_alg_stage_marg_fig <- 
    ggplot(water_CR_alg_stage_draws, 
           aes(x = .value, y = contrast, 
               fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi')  +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage), nrow = 2) +
    theme_minimal() +
    xlim(-0.4, 0.4) +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))

```

```{r WATER CR_ALG: plot, echo = FALSE, fig.align ='center'}
(water_CR_ALG_figure = 
   ggplot(
     data = water_alg_dat_avg_CR,
       aes(x = Sample_date, y = CR_treat_avg, 
           group = Treatment, shape = Treatment)) +
  #geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
  geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.2),
      lwd = 0.75) +
  geom_errorbar(
      aes(ymin = CR_treat_avg - CR_treat_se, 
          ymax = CR_treat_avg + CR_treat_se),
      position = position_dodge(0.3),
      width = 0.3) +
  # geom_jitter(
  #   data = alg_dat_filt, aes(x = Sample_date, y = GPP_avg, 
  #                            group = Treatment),
  #             position = position_jitter(0.15),
  #             alpha = 0.3,
  #             size = 2,
  #             fill = 'black') +
  geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
  labs(y = expression("Community respiration rate" ~ (mgO^2/m^2/h)), 
       x = 'Sampling period') +
  theme_classic() +
 scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5))+
    scale_x_continuous(breaks = unique(water_alg_dat_avg_CR$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

```{r WATER CHL_A MS FIGURE, include = FALSE}
(WATER_CR_figs <- water_CR_ALG_figure + water_CR_alg_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "WATER_CR_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```


# 4. Zooplankton

## Pre-processing

```{r Load plankton data, echo=FALSE}
plank_dat_wide <- readRDS(paste0(data_path, "plankton_data_wide.rds"))
```

```{r Pre-processing plankton data, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
plankton_dat_avg <- plank_dat_wide %>%
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    num_species_avg = mean(num_species_found),
    num_species_se = sd(num_species_found)/sqrt(n()),
    total_abundance_avg = mean(total_abundance),
    total_abundance_se = sd(total_abundance)/sqrt(n()),
         )

plank_dat_filt <- plank_dat_wide %>% 
  filter(!Sample_date == 1)

```

```{r Plankton summary stats, echo = FALSE}
summary_stats(plank_dat_wide, "num_species_found", c("Stage", "Treatment"))
summary_stats(plank_dat_wide, "total_abundance", c("Stage", "Treatment"))
```

### 3.1. Total abundance

```{r ABUND:  data exploration, fig.align='center'}
#histogram of total zooplankton abundance
plank_dat_wide  %>% 
  ggplot(aes(x = total_abundance)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
```

```{r ABUND: prior checks, echo = FALSE}
#NEG BINOM
#prior check to see if the regularizing prior we set makes sense
#alpha coefficent
tibble(x       = c(3, 22),
       y       = c(0.055, 0.04),
       meanlog = c(0, 4.5),
       sdlog   = c(10, 1)) %>% 
  expand(nesting(x, y, meanlog, sdlog),
         number = seq(from = 0, to = 500, length.out = 200)) %>% 
  mutate(density = dlnorm(number, meanlog, sdlog),
         group   = str_c("alpha%~%Normal(", meanlog, ", ", sdlog, ")")) %>% 
  ggplot(aes(fill = group, color = group)) +
  geom_area(aes(x = number, y = density),
            alpha = 3/4, size = 0, position = "identity") +
  geom_text(data = . %>% group_by(group) %>% slice(1),
            aes(x = x, y = y, label = group),
            family = "Times", parse = T,  hjust = 0) 

exp(4 + 1^2 / 2)

#beta-coeffcient
tibble(i = 1:100,
       a = rnorm(100, mean = 4, sd = 1)) %>% 
  mutate(`beta%~%Normal(0*', '*0.3)`  = rnorm(100, mean = 0 , sd = 0.3),
         `beta%~%Normal(0*', '*1)` = rnorm(100, mean = 0 , sd = 1)) %>% 
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand_grid(x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = exp(a + b * x), group = i)) +
  geom_line(linewidth = 1/4, alpha = 2/3,
            color = wesanderson::wes_palette("Moonrise2")[4])+
  coord_cartesian(ylim = c(0, 500)) +
  facet_wrap(~ prior, labeller = label_parsed)

#GAUSSIAN - will be on the log scale
#prior check for non HR standardized model
# simulate and wrangle
tibble(i = 1:100,
       a = rnorm(100, mean = 1, sd = 0.1)) %>% 
  mutate(`beta%~%Normal(0*', '*1)`  = rnorm(100, mean = 0 , sd = 1),
         `beta%~%Normal(0*', '*0.5)` = rnorm(100, mean = 0 , sd = 0.5),
         `beta%~%Normal(0*', '*0.2)` = rnorm(100, mean = 0 , sd = 0.3)) %>% #
  pivot_longer(contains("beta"),
               values_to = "b",
               names_to = "prior") %>% 
  expand(nesting(i, a, b, prior),
         x = seq(from = -2, to = 2, length.out = 100)) %>% 
  
  # plot
  ggplot(aes(x = x, y = a + b * x, group = i)) +
  geom_line(size = 1/4, alpha = 2/3,
            color = 'blue') +
  labs(x = "x",
       y = "log total abundance") +
  coord_cartesian(ylim = c(-2, 20)) +
  facet_wrap(~ prior, labeller = label_parsed)
```

```{r ABUND: modelling, echo = FALSE, cache = TRUE}
#Given count data, use either poisson or negative binomial. Probably the latter due to issues with overdispersion. However, we will run two model, one using poisson and the other using negative binomial, and when we will compare these two models using LOO model comparison. 

#set the model structure
tot_abund.bf = 
  bf(total_abundance ~ 1 + Stage*Treatment + Sample_date + Avg_length_std +(1|Mesocosm))

# #I will also set the model structure for a gaussian model where total abundance is log transformed
# tot_abund_gaus.bf = 
#   bf(log10(total_abundance) ~ 1 + Stage*Treatment + Sample_date + Avg_length_std +(1|Mesocosm))

#check prior specs.
#get_prior(tot_abund.bf, data = plank_dat_wide, family = poisson())
get_prior(tot_abund.bf, data = plank_dat_wide, family = negbinomial(link = 'log'))

#set prior for negative binom model
negbinom.prior = 
  prior = c(
    set_prior("normal(4.5, 1)", class = "Intercept"),
    set_prior("normal(0, 1)", class = "b"),
    set_prior("gamma(0.01, 0.01)", class = 'shape'))

# #set prior for gaussian model
# gaussian.prior = prior = c(
#   set_prior("normal(1, 0.1)", class = "Intercept"),
#   set_prior("normal(0, 0.5)", class = "b"),
#   set_prior("exponential(1)", class = 'sigma'))
# #this prior restricts most estimates to be positive which makes sense because you can not have negative zooplankton abundance

#run negbinom model
tot_abund_negbinom.model = 
  brm(
    tot_abund.bf, 
    data = plank_dat_filt, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = negbinomial(link = 'log'),
    prior = negbinom.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'tot_abund_negbinom.model'),
    file_refit = getOption(paste0(model_path, 'tot_abund_negbinom.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

# #run poisson model
# tot_abund_pois.model = 
#   brm(
#     tot_abund.bf, 
#     data = plank_dat_filt, 
#     cores = 4, chains = 4, warmup = 1000, iter = 2000,
#     seed = 1222, 
#     family = poisson(),
#     save_pars = save_pars(all = TRUE),
#     file = paste0(model_path, 'tot_abund_pois.model'),
#     file_refit = getOption(paste0(model_path, 'tot_abund_pois.model'), 'on_change'),
#     control = list(adapt_delta = 0.99))

# #run gaussian model
# tot_abund_gaus.model =
#   brm(
#     tot_abund_gaus.bf,
#     data = plank_dat_filt,
#     cores = 4, chains = 4, warmup = 1000, iter = 2000,
#     seed = 1222,
#     family = gaussian(),
#     prior = gaussian.prior,
#     save_pars = save_pars(all = TRUE),
#     sample_prior = TRUE,
#     file = paste0(model_path, 'tot_abund_gaus.model'),
#     file_refit = getOption(paste0(model_path, 'tot_abund_gaus.model'), 'on_change'),
#     control = list(adapt_delta = 0.99))

# #also going to run a gaussian model with the default prior for comparison to our model with a regularizing priors
# tot_abund_gaus_wdefaultprior.model =
#   brm(
#     tot_abund_gaus.bf,
#     data = plank_dat_filt,
#     cores = 4, chains = 4, warmup = 1000, iter = 2000,
#     seed = 1222,
#     family = gaussian(),
#     save_pars = save_pars(all = TRUE),
#     sample_prior = TRUE,
#     file = paste0(model_path, 'tot_abund_gaus_wdefaultprior.model'),
#     file_refit = getOption(paste0(model_path, 'tot_abund_gaus_wdefaultprior.model'), 'on_change'),
#     control = list(adapt_delta = 0.99))

# #compare negbinom and poisson models
# pois_loo<- loo(tot_abund_pois.model, moment_match = T) #lots of pareto k issues
# negbinom_loo<- loo(tot_abund_negbinom.model, moment_match = T) # only a couple of pareto k issues
# gaus_loo <- loo(tot_abund_gaus.model, moment_match = T)
# gaus_def_loo <- loo(tot_abund_gaus_wdefaultprior.model, moment_match = T)
# loo_compare(pois_loo, negbinom_loo) #clear neg binompreferred
# loo_compare(gaus_loo, gaus_def_loo)

#posterior predictive check
#pp_check(tot_abund_pois.model, ndraws = 100) #looks bad
pp_check(tot_abund_negbinom.model, ndraws = 100)  #looks good
#pp_check(tot_abund_gaus.model, ndraws = 100) #looks good
#pp_check(tot_abund_gaus_wdefaultprior.model, ndraws = 100) #looks good

#posterior predictive check with pp_check. Note we use type = 'ecdf_overlay' because  the default smoothed output may be inappropriate for discrete data (see Winter & Burkuner 2021)
#pp_check(tot_abund_pois.model, ndraws = 100, type = 'ecdf_overlay') 
pp_check(tot_abund_negbinom.model, ndraws = 100, type = 'ecdf_overlay') #Neg biom looks the good

#summary of full model 
summary(tot_abund_negbinom.model, prob = 0.95)
#summary(tot_abund_gaus.model, prob = 0.95)
#summary(tot_abund_gaus_wdefaultprior.model, prob = 0.95)

#Conditional effects neg binom
total_abund_cond_eff = plot(conditional_effects(tot_abund_negbinom.model), plot = F)
total_abund_cond_eff$Treatment
total_abund_cond_eff$Stage
total_abund_cond_eff$Avg_length_std
total_abund_cond_eff$Sample_date
total_abund_cond_eff$`Stage:Treatment`

# #Conditional effects gaus
# total_abund_cond_eff = plot(conditional_effects(tot_abund_gaus.model), plot = F)
# total_abund_cond_eff$Treatment
# total_abund_cond_eff$Stage
# total_abund_cond_eff$Avg_length_std
# total_abund_cond_eff$Sample_date
# total_abund_cond_eff$`Stage:Treatment`
# 
# total_abund_cond_eff = plot(conditional_effects(tot_abund_gaus_wdefaultprior.model), plot = F)
# total_abund_cond_eff$Treatment
# total_abund_cond_eff$Stage
# total_abund_cond_eff$Avg_length_std
# total_abund_cond_eff$Sample_date
# total_abund_cond_eff$`Stage:Treatment`

#add waic and loo criterion 
tot_abund_negbinom.model <- 
  add_criterion(
    tot_abund_negbinom.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'tot_abund_negbinom.model'))

```

```{r ABUND: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
abund_b_params <- 
  summary(tot_abund_negbinom.model, prob = 0.95)$fixed 

(abund_b_params <- 
    rownames_to_column(abund_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(abund_model_table = 
    qflextable(abund_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(abund_model_table, 
             path = paste0(table_path, "abund_model_table.docx"))
```

```{r ABUND: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
abund.stage.emm <- emmeans(tot_abund_negbinom.model, ~ Stage|Treatment, type = 'response')

#function for calculating percent change
pct.diff.tran <- list(
    linkfun = function(mu) log(mu/100 + 1),
    linkinv = function(eta) 100 * (exp(eta) - 1),
    mu.eta = function(eta) 100 * exp(eta),
    name = "log(pct.diff)"
)

(abund.stage.cont = 
  as.data.frame(
    contrast(abund.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0, -1,0,1)), tran = pct.diff.tran)))
  
#Difference between treatments at each stage
(abund_treat.emm <- emmeans(tot_abund_negbinom.model, ~ Treatment|Stage, type = 'response'))
contrast(
    abund_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))
```

```{r ABUND: find whether differences among stage are sig diff between treatment, echo = FALSE}
control_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Control',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1))) %>% 
  gather_emmeans_draws()

low_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'Low',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1))) %>% 
  gather_emmeans_draws()

high_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Stage,
           at = list(Treatment = 'High',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>%
  contrast(list(
    'Establishment vs. Fish only' = c(-1, 1, 0, 0),
    'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
    'Fish & Flx vs. Flx only ' = c(0,0, -1, 1))) %>% 
  gather_emmeans_draws()

total_abund_treat_draws <- 
  rbind(
    cbind(control_total_abund_draws, data.frame(Treatment = 'Control')),
    cbind(low_total_abund_draws, data.frame(Treatment = 'Low')),
    cbind(high_total_abund_draws, data.frame(Treatment = 'High')))

total_abund_treat_draws$Treatment <- 
  factor(total_abund_treat_draws$Treatment,
         levels = c('Control',
                    'Low',
                    'High'))


#Now compare effect size changes between stages among treatments

#control v low comp
  total_abund_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'High') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - Low)

#control v high comp
  total_abund_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Low') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Control - High)

#low v high comp
  total_abund_treat_draws %>% 
  select(-.iteration, -.chain) %>% 
  filter(!Treatment == 'Control') %>% 
  pivot_wider(names_from = Treatment,
              values_from = .value) %>% 
  group_by(contrast) %>% 
  mean_hdi(Low - High)

```

```{r ABUND stage contrasts model predictions, echo = FALSE}
#Establishment
estab_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Fish_exposure
fish_exp_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_total_abund_draws <- tot_abund_negbinom.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Avg_length_std = mean(plank_dat_wide$Avg_length_std),
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#combined
total_abund_stage_draws <- 
  rbind(
    cbind(estab_total_abund_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_total_abund_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_total_abund_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_total_abund_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


total_abund_stage_draws$Stage <- 
  factor(total_abund_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

total_abund_stage_draws$contrast <- factor(total_abund_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

total_abund_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  mean_hdi()


#plot
(stage_marg_fig <- 
    ggplot(total_abund_stage_draws, 
           aes(x = .value, y = contrast, fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi') +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    theme_minimal() +
    xlim(-400, 400)+
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r ABUND marginal effects FIGURE, include = FALSE}
ggsave(
  filename = paste0(figure_path, "abund_stage_marg_fig.pdf"), 
  width = 210,
  height = 150,
  units = 'mm',
  device = 'pdf')
```

```{r ABUND:FIGURE, echo = FALSE, fig.align='center'}
(total_abundance_figure = 
   ggplot(
     data = plankton_dat_avg, 
     aes(x = Sample_date, y = total_abundance_avg, 
         group = Treatment, shape = Treatment)) +
   geom_line(
     aes(linetype = Treatment),
     position = position_dodge(0.2),
     lwd = 0.75) +
   geom_errorbar(
     aes(ymin = total_abundance_avg - total_abundance_se, 
         ymax = total_abundance_avg + total_abundance_se),
                 position = position_dodge(0.3),
                 width = 0.3) +
   # geom_jitter(data = plank_dat_wide, 
   #             aes(x = Sample_date, y = total_abundance, group = Treatment),
   #             position = position_jitter(0.15),
   #             alpha = 0.5,
   #             size = 2) +
   geom_point(aes(shape = Treatment),
              position = position_dodge(0.3),
              size = 3,
              fill = 'white',
              color = 'black') +
   labs(y = "Zooplankton abundance", 
        x = '') +
   theme_classic() +
   scale_shape_manual(values = c(21, 22, 24))+
   scale_linetype_manual(values = c(1,3,5))+
   scale_x_continuous(breaks = unique(plank_dat_wide$Sample_date))+
   guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
   theme(legend.position = 'none',
         panel.grid.minor = element_blank()))

```

```{r ABUND MS FIGURE, include = FALSE}
(ABUND_figs <- total_abundance_figure + stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "ABUND_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```


### 3.2. Diversity

```{r DIVERSE data exploration, fig.align='center', echo = FALSE}
#histogram of total zooplankton abundance
plank_dat_wide  %>% 
  ggplot(aes(x = num_species_found)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
  
```

```{r DIVERSE figure, echo = FALSE}
(diversity_figure = 
   ggplot(data = plankton_dat_avg, 
          aes(x = Sample_date, y = num_species_avg, group = Treatment, shape = Treatment)) +
   geom_vline(xintercept = 2, linetype = "dashed", color = "black") +
   geom_line(position = position_dodge(0.2),
             lwd = 0.75) +
   geom_errorbar(aes(ymin = num_species_avg - num_species_se, ymax = num_species_avg + num_species_se),
                 position = position_dodge(0.2),
                 width = 0.2) +
   geom_jitter(data = plank_dat_wide, aes(x = Sample_date, y = num_species_found, group = Treatment),
               position = position_jitter(0.15),
               alpha = 0.3,
               size = 2,
               fill = 'black') +
   geom_point(aes(shape = Treatment),
              position = position_dodge(0.2),
              size = 3,
              fill = 'white',
              color = 'black') +
   labs(y = "Number of unique zooplankton species detected", 
        x = 'Sampling period') +
   theme_bw() +
   scale_shape_manual(values = c(21, 22, 24)) +
   scale_x_continuous(breaks = unique(plank_dat_wide$Sample_date))+
   guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
   theme(legend.position = 'none',
         panel.grid.minor = element_blank(),
         plot.margin = unit(c(1,1,1,1), "cm")))
```

```{r DIVERSE modelling, echo = FALSE, cache = TRUE}
#Given count data, use either poisson or negative binomial. Probably the latter due to issues with overdispersion. However, we will run two model, one using poisson and the other using negative binomial, and when we will compare these two models using LOO model comparison. 

#set the model structure
diversity.bf = 
  bf(num_species_found ~ 1 + Stage*Treatment + Sample_date + Avg_length_std + (1|Mesocosm))

# #I will also set the model structure for a gaussian model where total abundance is log transformed
# tot_abund_gaus.bf = 
#   bf(log10(total_abundance) ~ 1 + Stage*Treatment + Sample_date + Avg_length_std +(1|Mesocosm))

#check prior specs.
get_prior(diversity.bf, data = plank_dat_wide, family = poisson())
get_prior(diversity.bf, data = plank_dat_wide, family = negbinomial(link = 'log'))

#set prior for negative binom model
negbinom.prior = 
  prior = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("normal(0, 0.5)", class = "b"),
    set_prior("gamma(0.01, 0.01)", class = 'shape'))

# #set prior for gaussian model
# gaussian.prior = prior = c(
#   set_prior("normal(1, 0.1)", class = "Intercept"),
#   set_prior("normal(0, 0.5)", class = "b"),
#   set_prior("exponential(1)", class = 'sigma'))
# #this prior restricts most estimates to be positive which makes sense because you can not have negative zooplankton abundance

#run negbinom model
diversity_negbinom.model = 
  brm(
    diversity.bf, 
    data = plank_dat_filt, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = negbinomial(link = 'log'),
    prior = negbinom.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'diversity_negbinom.model'),
    file_refit = getOption(paste0(model_path, 'diversity_negbinom.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#run poisson model
diversity_pois.model =
  brm(
    diversity.bf,
    data = plank_dat_filt,
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222,
    family = poisson(),
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'diversity_pois.model'),
    file_refit = getOption(paste0(model_path, 'diversity_pois.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

# #compare negbinom and poisson models
pois_loo<- loo(diversity_pois.model, moment_match = T) #lots of pareto k issues
negbinom_loo<- loo(diversity_negbinom.model, moment_match = T) # only a couple of pareto k issues
loo_compare(pois_loo, negbinom_loo) #no difference...stick with poisson

#posterior predictive check
pp_check(diversity_pois.model, ndraws = 100) #looks bad
pp_check(diversity_negbinom.model, ndraws = 100)  #looks good

#posterior predictive check with pp_check. Note we use type = 'ecdf_overlay' because  the default smoothed output may be inappropriate for discrete data (see Winter & Burkuner 2021)
pp_check(diversity_pois.model, ndraws = 100, type = 'ecdf_overlay') 
pp_check(diversity_negbinom.model, ndraws = 100, type = 'ecdf_overlay') #Neg biom looks the good

#summary of full model 
summary(diversity_pois.model, prob = 0.95)
summary(diversity_negbinom.model, prob = 0.95)

#add waic and loo criterion 
diversity_pois.model <- 
  add_criterion(
    diversity_pois.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'diversity_pois.model'))

```

```{r DIVERSE compare model with and without interaction, echo = FALSE}
diversity_pois_noint.model <- 
  update(
    diversity_pois.model,
    formula. = ~. -Stage:Treatment,
    cores = 4, chains = 4, warmup = 1000,
    iter = 2000, seed = 1222,
    file_refit = getOption(paste0(model_path, 'diversity_pois_noint.model'), 'on_change'))

#add waic and loo criterion 
diversity_pois_noint.model <- 
  add_criterion(
    diversity_pois_noint.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'diversity_pois_noint.model'))

#loo comparison
print(loo_compare(diversity_pois.model,
                  diversity_pois_noint.model,
                  criterion = 'loo'), 
      simplify = F) 

model_weights(diversity_pois.model,
              diversity_pois_noint.model,
              weights = 'loo') %>% 
  round(digits = 3)
```

```{r DIVERSE planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
diversity.emm <- emmeans(diversity_pois.model, ~ Stage|Treatment)
contrast(diversity.emm, list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                               'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                               'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)))


#Difference between treatments at each stage
diversity2.emm <- emmeans(diversity_pois.model, ~ Treatment|Stage)
contrast(diversity2.emm, list('Control vs. Low' = c(-1, 1, 0),
                                'Control vs. High' = c(-1, 0, 1),
                                'Low vs. High' = c(0, -1, 1)))
```

## 3.3 Summary of zooplankton present

```{r DIVERSE plankton diversity sum stats TABLE, echo = FALSE, include = FALSE}
#Get averages
plankton_species_avg <- 
  plank_dat_wide %>%
  group_by(Treatment, Stage) %>%
  summarise_at(vars(4:22), ~ceiling(mean(., na.rm = T))) %>% 
  select(-c(20:21)) %>%
  pivot_longer(
    cols = c(5:18),
    names_to = 'Species',
    values_to = 'Number') %>% 
  mutate(prop = Number/total_abundance)


plankton_species_avg_filt <- 
  plankton_species_avg %>% 
  group_by(Treatment, Stage) %>% 
  arrange(Treatment, Stage, desc(Number)) %>% 
  slice_head(n = 5) %>% 
  select(-num_order_found, -prop)


(plank_diverse_table = 
    qflextable(plankton_species_avg_filt) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(plank_diverse_table, path = paste0(table_path, "plank_diverse_table.docx"))
```

# 4. Nutrients

```{r NUT: load data, echo=FALSE}
nut_dat <- readRDS(paste0(data_path, "nutrient_data.rds"))
```

```{r NUT: data processing, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
nut_dat_avg <- nut_dat %>%
  group_by(Treatment, Stage, Date, Sample_date) %>%
  reframe(
    NH3_mgL_treat_avg = mean(NH3_mgL),
    NH3_mgL_treat_se = sd(NH3_mgL)/sqrt(n()),
    FRP_mgL_treat_avg = mean(FRP_mgL),
    FRP_treat_se = sd(FRP_mgL)/sqrt(n()),
    Nox_mgL_treat_avg = mean(Nox_mgL),
    Nox_treat_se = sd(Nox_mgL)/sqrt(n())
         )
```

```{r NUT: data exploration, fig.align='center'}
#histogram of NH3_mgL
nut_dat %>%
  ggplot(aes(x = NH3_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
  
#histogram of FRP_mgL
nut_dat %>% 
  ggplot(aes(x = FRP_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

#histogram of Nox_mgL
nut_dat %>% 
  ggplot(aes(x = Nox_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
```

```{r NUT: summary stats, echo = FALSE}
summary_stats(nut_dat, "NH3_mgL", c("Stage", "Treatment"))
summary_stats(nut_dat, "FRP_mgL", c("Stage", "Treatment"))
summary_stats(nut_dat, "Nox_mgL", c("Stage", "Treatment"))
```

```{r NUT summary stats TABLE, echo = FALSE, include = FALSE}
NH3.sum.stats = summary_stats(nut_dat, "NH3_mgL", c("Treatment", "Stage"))
FRP.sum.stats = summary_stats(nut_dat, "FRP_mgL", c("Treatment", "Stage"))
Nox.sum.stats = summary_stats(nut_dat, "Nox_mgL", c("Stage", "Treatment"))

#use flextable to create a table in a word document
#NH3
NH3.sum.stats = 
  NH3.sum.stats %>% 
  mutate_if(is.numeric, round, 4) %>% 
  select(-SE)

(NH3_table = 
    qflextable(NH3.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(NH3_table, path = paste0(table_path, "NH3_table.docx"))

#FRP
FRP.sum.stats = 
  FRP.sum.stats %>% 
  mutate_if(is.numeric, round, 4) %>% 
  select(-SE)

(FRP_table = 
    qflextable(FRP.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(FRP_table, path = paste0(table_path, "FRP_table.docx"))

#NOX
Nox.sum.stats = 
  Nox.sum.stats %>% 
  mutate_if(is.numeric, round, 4) %>% 
  select(-SE)

(Nox_table = 
    qflextable(Nox.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(Nox_table, path = paste0(table_path, "Nox_table.docx"))
```

## 4.1. Ammonia (NH3)

```{r NH3 barchart, echo = FALSE, fig.align='center'}
NH3_fig_dat <-  summary_stats(nut_dat, "NH3_mgL", c("Stage", "Treatment"))

# Assuming you have defined the "Johnson" vector with appropriate colors before this code.

ggplot(NH3_fig_dat, aes(x = Stage, y = Mean, fill = Treatment)) +
  geom_bar(stat = 'identity', 
           position = position_dodge(), 
           color = 'black',
           alpha = 0.5) +
  geom_jitter(data = nut_dat, aes(x = Stage, y = NH3_mgL, color = Treatment),
             position = position_jitterdodge(0.25),
             size = 2,
             alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), 
                width = 0.2,
                position = position_dodge(0.9)) +
  theme_bw() +
  scale_fill_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  scale_color_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  labs(x = '', y = 'Average ammonia concentration (mg/L)') +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12))
```

```{r NH3 modelling, echo = FALSE, cache = TRUE}
#log and scale NH3 variable 
nut_dat$NH3_mgL_log = as.numeric(log10(nut_dat$NH3_mgL))

#set the model structure
ammonia.bf = 
  bf(NH3_mgL_log ~ 1 + Stage*Treatment + Sample_date + Avg_length_std +(1|Mesocosm))

#check prior specs.
get_prior(ammonia.bf, data = nut_dat, family = gaussian())

#set prior for negative binom model
gaus.prior = 
  prior = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("normal(0, 1)", class = "b"),
    set_prior("exponential(1)", class = 'sd'))

#run  model
ammonia_gaus.model = 
  brm(
    ammonia.bf, 
    data = nut_dat, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    prior = gaus.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'ammonia_gaus.model'),
    file_refit = getOption(paste0(model_path, 'ammonia_gaus.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check
pp_check(ammonia_gaus.model, ndraws = 100) #looks a little funky

#summary of full model 
summary(ammonia_gaus.model, prob = 0.95)

#add waic and loo criterion 
ammonia_gaus.model <- 
  add_criterion(
    ammonia_gaus.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'ammonia_gaus.model'))
```


```{r NH3: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
ammonia_b_params <- 
  summary(ammonia_gaus.model, prob = 0.95)$fixed 

(ammonia_b_params <- 
    rownames_to_column(ammonia_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(ammonia_model_table = 
    qflextable(ammonia_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(ammonia_model_table, 
             path = paste0(table_path, "ammonia_model_table.docx"))
```


```{r NH3 planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(NH3.stage.emm <- emmeans(ammonia_gaus.model, ~ Stage|Treatment, type = 'response'))

(NH3_model_preds <- as.data.frame(NH3.stage.emm) %>% 
  mutate_if(is.numeric, ~ exp(.)))

#function for calculating percent change
pct.diff.tran <- list(
    linkfun = function(mu) log(mu/100 + 1),
    linkinv = function(eta) 100 * (exp(eta) - 1),
    mu.eta = function(eta) 100 * exp(eta),
    name = "log(pct.diff)"
)

(NH3.stage.cont = 
  as.data.frame(
    contrast(NH3.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0, -1,0,1)), tran = pct.diff.tran)))
  
#Difference between treatments at each stage
(NH3_treat.emm <- emmeans(tot_NH3_negbinom.model, ~ Treatment|Stage, type = 'response'))
contrast(
    NH3_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))
```


## 4.2. Filterable reactive phosphorus (FRP)

```{r}
#histogram of FRP_mgL
nut_dat %>% 
  ggplot(aes(x = FRP_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

#log transformed
nut_dat %>% 
  ggplot(aes(x = log10(FRP_mgL))) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

```

```{r FRP barchart, echo = FALSE, fig.align='center'}
FRP_fig_dat <-  summary_stats(nut_dat, "FRP_mgL", c("Stage", "Treatment"))

ggplot(FRP_fig_dat, aes(x = Stage, y = Mean, fill = Treatment)) +
  geom_bar(stat = 'identity', 
           position = position_dodge(), 
           color = 'black',
           alpha = 0.5) +
  geom_jitter(data = nut_dat, aes(x = Stage, y = FRP_mgL, color = Treatment),
             position = position_jitterdodge(0.25),
             size = 2,
             alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), 
                width = 0.2,
                position = position_dodge(0.9)) +
  theme_bw() +
  scale_fill_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  scale_color_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  labs(x = '', y = 'Average filtered reactive phosphorus (mg/L)') +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12))

```

```{r FRP modelling, echo = FALSE, cache = TRUE}
#log and scale FRP variable 
nut_dat$FRP_mgL_log = as.numeric(log10(nut_dat$FRP_mgL))

#set the model structure
phos.bf = 
  bf(FRP_mgL_log ~ 1 + Stage*Treatment + Sample_date + Avg_length_std +(1|Mesocosm))

#check prior specs.
get_prior(phos.bf, data = nut_dat, family = gaussian())

#set prior for negative binom model
gaus.prior = 
  prior = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("normal(0, 1)", class = "b"),
    set_prior("exponential(1)", class = 'sd'))

#run  model
phos_gaus.model = 
  brm(
    phos.bf, 
    data = nut_dat, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    prior = gaus.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'phos_gaus.model'),
    file_refit = getOption(paste0(model_path, 'phos_gaus.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check
pp_check(phos_gaus.model, ndraws = 100) #looks a little funky

#summary of full model 
summary(phos_gaus.model, prob = 0.95)

#add waic and loo criterion 
phos_gaus.model <- 
  add_criterion(
    phos_gaus.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'phos_gaus.model'))
```


```{r FRP: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
phos_b_params <- 
  summary(phos_gaus.model, prob = 0.95)$fixed 

(phos_b_params <- 
    rownames_to_column(phos_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to create a table in a word document  
(phos_model_table = 
    qflextable(phos_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(phos_model_table, 
             path = paste0(table_path, "phos_model_table.docx"))
```


```{r FRP planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(FRP.stage.emm <- emmeans(phos_gaus.model, ~ Stage|Treatment, type = 'response'))

(FRP_model_preds <- as.data.frame(FRP.stage.emm) %>% 
  mutate_if(is.numeric, ~ exp(.)))

#function for calculating percent change
pct.diff.tran <- list(
    linkfun = function(mu) log(mu/100 + 1),
    linkinv = function(eta) 100 * (exp(eta) - 1),
    mu.eta = function(eta) 100 * exp(eta),
    name = "log(pct.diff)"
)

(FRP.stage.cont = 
  as.data.frame(
    contrast(FRP.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish only vs. Flx only' = c(0, -1,0,1)), tran = pct.diff.tran)))
  
#Difference between treatments at each stage
(FRP_treat.emm <- emmeans(tot_FRP_negbinom.model, ~ Treatment|Stage, type = 'response'))
contrast(
    FRP_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))
```




## 4.3. NOx

```{r NOX barchart, echo = FALSE, fig.align='center'}
Nox_fig_dat <-  summary_stats(nut_dat, "Nox_mgL", c("Stage", "Treatment"))

ggplot(Nox_fig_dat, aes(x = Stage, y = Mean, fill = Treatment)) +
  geom_bar(stat = 'identity', 
           position = position_dodge(), 
           color = 'black',
           alpha = 0.5) +
  geom_jitter(data = nut_dat, aes(x = Stage, y = Nox_mgL, color = Treatment),
             position = position_jitterdodge(0.25),
             size = 2,
             alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), 
                width = 0.2,
                position = position_dodge(0.9)) +
  theme_bw() +
  scale_fill_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  scale_color_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
  labs(x = '', y = ' Average nitric oxide (mg/L)') +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12))
```



# 5. Insect chemistry

```{r load insect chem data, echo=FALSE}
ins_chem_dat <- readRDS(paste0(data_path, "insect_chem_data.rds"))
```

```{r insect chem sum stats, echo = FALSE}
#any flx in control
ins_chem_dat %>%
  group_by(Treatment) %>% 
  summarise(num_detects = n(),
            det_samples = sum(FLX_ng > 0, na.rm = TRUE),
            per_samples = det_samples/num_detects)

#check how much flx was detected in each mesocosm and treatment
summary_stats(ins_chem_dat, "FLX_ng", "Treatment")

#by insect
ins_chem_sum = summary_stats(ins_chem_dat, "FLX_ng", c("Treatment", 'Inv_species'))

#number of unique insects in dataset
length(unique(ins_chem_dat_filt$Inv_species)) #4
```

```{r create insect data table, include = FALSE, echo = FALSE}
#use flextable to create a table in a word document  
ins_chem_sum = 
  ins_chem_sum %>% 
  mutate_if(is.numeric, round, 2) %>% 
  dplyr::select(-SE)


(insect_chem_table = 
    qflextable(ins_chem_sum) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(insect_chem_table, path = paste0(table_path, "insect_chem_table.docx"))
```


```{r insect chem histogram, echo = FALSE}
ggplot(ins_chem_dat, aes(x = FLX_ng)) +
  geom_histogram(binwidth = 0.2, color = 'black') +
  labs(x = "Fluoxetine ng", y  = "Count",
       title = "Fluxoxetine concentration in nanograms per litre found in different invertebrate classes within each treatment") +
  theme_bw()
```

```{r insect chem figure barchart, echo = FALSE, fig.align='center'}
fig_dat <-  tibble(summary_stats(ins_chem_dat_filt, "FLX_ng", c("Treatment", 'Inv_species')))

ggplot(fig_dat, aes(x = Inv_species, y = Mean,fill = Treatment)) +
  geom_bar(stat = 'identity', 
           position = position_dodge(), 
           color = 'black',
           alpha = 0.5) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), 
                width = .2,
                position = position_dodge(.9)) +
  geom_jitter(data = ins_chem_dat_filt, aes(x = Inv_species, y = FLX_ng, color = Treatment),
             position = position_jitterdodge(0.25),
             size = 2) +
  theme_bw()+
  scale_fill_manual(values = c(Johnson[2], Johnson[3]))+
  scale_color_manual(values = c(Johnson[2], Johnson[3]))+
  labs(x = '', y = 'Mean detected fluoxetine concentration (ng/L)') +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12)) 

```

# 6. Water chemistry

```{r load water chem data, echo=FALSE}
water_chem_dat <- readRDS(paste0(data_path, "water_chem_data.rds"))
```

```{r water chem sum stats, echo = FALSE}
#any flx in control
water_chem_dat %>% 
  filter(Treatment == 'Control') %>% 
  reframe(len = sum(FLX_conc_ngL > 0, na.rm = TRUE)) #yes, 1 detection

#first I'm going to filter out Control becasue no fluoxetine was detected in controls. I also got rid of one date because this was an extra water sample we took for look at depuration rate a few days after dosing. All other sample dates were taken the day after dosing. 

water_chem_dat_filt <- 
  water_chem_dat %>% 
  filter(!Treatment == 'Control') %>% 
  filter(!Date == '2020-11-10')

#check how much flx was detected in each mesocosm and treatment
water_chem_sum_stats = summary_stats(water_chem_dat_filt, "FLX_conc_ngL", c("Treatment", "Stage"))
```

```{r create water chem data table, include = FALSE, echo = FALSE}
water_chem_sum_stats = 
  water_chem_sum_stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  dplyr::select(-SE)

(water_chem_table = 
    qflextable(water_chem_sum_stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(water_chem_table, path = paste0(table_path, "water_chem_table.docx"))
```


```{r WATER CHEM barchart FIGURE, echo = FALSE, fig.align='center'}
fig_dat <-  summary_stats(water_chem_dat, "FLX_conc_ngL", c("Treatment", "Stage"))

ggplot(fig_dat, aes(x = Stage, y = Mean,fill = Treatment)) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), 
                width = .2,
                position = position_dodge(.9)) +
  geom_bar(stat = 'identity', 
           position = position_dodge(), 
           color = 'black') +
  theme_bw()+
  scale_fill_manual(values = c(Johnson[1], Johnson[2], Johnson[3]))+
  labs(x = '', y = 'Mean detected fluoxetine water concentration (ng/L)') +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12)) 

```

## 6.1. Bioaccumulation factors

BAF (L/Kg) = concentration in the tissue or bug (in ug/Kg) / concentration in water (in ug/L).

```{r BAF - combine datasets for calculation}
#First I will calculate the average detected concentration for each mesocosm
water_chem_dat_sum <- 
  water_chem_dat %>% 
  filter(!Treatment == 'Control') %>% 
  group_by(Treatment, Mesocosm) %>% 
  summarise(mean_flx_conc = mean(FLX_conc_ngL, na.rm = T)/1000)

#combine
chem_dat_bcf = merge(ins_chem_dat, water_chem_dat_sum, by = 'Mesocosm')

#add column for bcf calc
chem_dat_bcf <- 
  chem_dat_bcf %>% 
  mutate(bcf_calc = FLX_ng/mean_flx_conc)

summary_stats(chem_dat_bcf, "bcf_calc", "Treatment.x")

```


# 7. Water parameters

## Pre-processing

```{r load water param data, echo=FALSE}
DO_CR_data <- readRDS(paste0(data_path, "DO_CR_data.rds"))
temp_ph_data <- readRDS(paste0(data_path, "temp_ph_data.rds"))
```



```{r TEMP/PH: data processing, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
temp_pd_dat_avg <- 
  temp_ph_data %>%
  group_by(Treatment, Stage, Time_of_day, Sample_date) %>%
  reframe(
    Temp_treat_avg = mean(Temp_avg, na.rm = T),
    Temp_treat_se = sd(Temp_avg, na.rm = T)/sqrt(n()),
    pH_treat_avg = mean(pH_avg, na.rm = T),
    pH_treat_se = sd(pH_avg, na.rm = T)/sqrt(n()))

```

```{r TEMP/PH summary stats TABLE, echo = FALSE, include = FALSE}
temp.sum.stats = summary_stats(temp_ph_data, "Temp_avg", c("Stage", "Treatment"))
ph.sum.stats = summary_stats(temp_ph_data, "pH_avg", c("Stage", "Treatment"))

#use flextable to create a table in a word document
#TEMP
temp.sum.stats = 
  temp.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(TEMP_table = 
    qflextable(temp.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 


save_as_docx(TEMP_table, path = paste0(table_path, "TEMP_table.docx"))

#PH
ph.sum.stats = 
  ph.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(PH_table = 
    qflextable(ph.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(PH_table, path = paste0(table_path, "PH_table.docx"))
```

## 7.1. Temperature

```{r TEMP: histograms, fig.align='center'}
#histogram of TEMP
temp_ph_data  %>% 
  ggplot(aes(x = Temp_avg )) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()
```

```{r TEMP: summary stats, echo = FALSE}
print(summary_stats(TEMP_data_long, "TEMP_mgL", c("Stage", "Treatment", "Time_of_day")), n = 36)
print(summary_stats(TEMP_data_long, "TEMP_perc", c("Stage", "Treatment", "Time_of_day")), n = 36)
summary_stats(TEMP_data_long, "TEMP_TEMP_mgL", c("Stage", "Treatment", "Sample_date"))
summary_stats(TEMP_data_long, "TEMP_TEMP_perc", c("Stage", "Treatment"))
```

```{r TEMP TEMP: modelling, echo = FALSE, cache = TRUE}
#set the model structure
TEMP.bf = 
  bf(TEMP_TEMP_mgL ~ 1 + Stage*Treatment + Sample_date +(1|Mesocosm))

#set prior
gaus.prior = 
  prior = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("normal(0, 1)", class = "b"),
    set_prior("exponential(1)", class = 'sd'))

#run model
TEMP_gaus.model = 
  brm(
    TEMP.bf, 
    data = TEMP_only_data, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    prior = gaus.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'TEMP_gaus.model'),
    file_refit = getOption(paste0(model_path, 'TEMP_gaus.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check
pp_check(TEMP_gaus.model, ndraws = 100) #looks okay

#summary of full model 
summary(TEMP_gaus.model, prob = 0.95)

#Conditional effects neg binom
TEMP_cond_eff = plot(conditional_effects(TEMP_gaus.model), plot = F)
TEMP_cond_eff$Treatment
TEMP_cond_eff$Stage
TEMP_cond_eff$Sample_date
TEMP_cond_eff$`Stage:Treatment`

#add waic and loo TEMPiterion 
TEMP_gaus.model <- 
  add_TEMPiterion(
    TEMP_gaus.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'TEMP_gaus.model.model'))

```

```{r TEMP: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
TEMP_b_params <- 
  summary(tot_TEMP_negbinom.model, prob = 0.95)$fixed 

(TEMP_b_params <- 
    rownames_to_column(TEMP_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 2) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to TEMPeate a table in a word TEMPcument  
(TEMP_model_table = 
    qflextable(TEMP_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Average fish length'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 14, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_TEMPcx(TEMP_model_table, 
             path = paste0(table_path, "TEMP_model_table.TEMPcx"))
```

```{r TEMP: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(TEMP.stage.emm <- emmeans(TEMP_gaus.model, ~ Stage|Treatment, type = 'response'))

(TEMP.stage.cont = 
  as.data.frame(
    contrast(TEMP.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1)))))

(TEMP.stage.emm_filt <- as.data.frame(TEMP.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean)) 

#combine
(TEMP.stage.cont_sum <- 
  cbind(TEMP.stage.cont, TEMP.stage.emm_filt))

(TEMP.stage.cont_sum <-  
  TEMP.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(aTEMPoss(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))
  
#Difference between treatments at each stage
(TEMP_treat.emm <- emmeans(TEMP_gaus.model, ~ Treatment|Stage, type = 'response'))
contrast(
    TEMP_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))
```

```{r TEMP stage contrasts model predictions, echo = FALSE}
#Establishment
estab_TEMP_draws <- TEMP_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_TEMP_draws <- TEMP_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Fish_exposure
fish_exp_TEMP_draws <- TEMP_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_TEMP_draws <- TEMP_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#combined
TEMP_stage_draws <- 
  rbind(
    cbind(estab_TEMP_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_TEMP_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_TEMP_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_TEMP_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


TEMP_stage_draws$Stage <- 
  factor(TEMP_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

TEMP_stage_draws$contrast <- factor(TEMP_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

TEMP_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  mean_hdi()


#plot
(TEMP_stage_marg_fig <- 
    ggplot(TEMP_stage_draws, 
           aes(x = .value, y = contrast, fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi') +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r TEMP marginal effects FIGURE, include = FALSE}
ggsave(
  filename = paste0(figure_path, "TEMP_stage_marg_fig.pdf"), 
  width = 210,
  height = 150,
  units = 'mm',
  device = 'pdf')
```

```{r RESPIRATION (DO mgL) plot, echo = FALSE, fig.align='center'}
#create a dataset for plotting purposes
DO_CR_fig_dat <- 
  summary_stats(DO_CR_data_long, "CR_DO_mgL", c("Stage", "Treatment", "Sample_date"))

(CR_DO_mgl_figure = 
    ggplot(data = DO_CR_fig_dat, 
           aes(x = Sample_date, y = Mean, 
               group = Treatment, shape = Treatment)) +
    #geom_vline(xintercept = 3, linetype = "dashed", color = "black") +
    geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.3),
      lwd = 0.75) +
    geom_errorbar(
      aes(ymin = Mean - SE, 
          ymax = Mean + SE),
      position = position_dodge(0.3),
      width = 0.3) +
    # #geom_jitter(data = water_param_dat_filt, aes(x = Sample_date, y = pH, 
    #                                              group = Treatment, fill = Treatment),
    #             position = position_jitter(0.15),
    #             alpha = 0.3,
    #             size = 2) +
    geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
    labs(y = 'Aerobic respiration (mg/L)', 
         x = 'Week') +
    theme_classic() +
    scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5)) +
    scale_x_continuous(breaks = unique(DO_CR_data_long$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

```{r DO_CR MS FIGURE, include = FALSE}
(DO_CR_figs <- CR_DO_mgl_figure + DO_CR_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "DO_CR_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```



```{r TEMP plot, echo = FALSE, fig.align='center'}
#Circles = control, square = low, triangle = high
#Filter row with no temp data for figure making
(temp_figure = 
   ggplot(data = temp_pd_dat_avg, 
          aes(x = Sample_date, y = Temp_treat_avg, 
              group = Treatment, shape = Treatment, fill = Treatment, color = Treatment)) +
   geom_vline(xintercept = 3, linetype = "dashed", color = "black") +
   geom_line(aes(x = Sample_date, y = Temp_treat_avg, group = Treatment)) +
   geom_errorbar(aes(ymin = Temp_treat_avg - Temp_treat_se, ymax = Temp_treat_avg + Temp_treat_se),
                 position = position_dodge(0.2),
                 width = 0.2) +
   geom_point(aes(shape = Treatment, fill = Treatment),
              position = position_dodge(0.2),
              size = 4) +
   geom_jitter(data = temp_ph_data, 
               aes(x = Sample_date, y = Temp_avg, 
                   group = Treatment, fill = Treatment),
               position = position_jitter(0.15),
               alpha = 0.3,
               size = 2) +
   labs(y = expression("Temperature ("*degree*C*")"), 
        x = 'Sampling period') +
   theme_bw() +
   scale_color_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
   scale_x_continuous(breaks = unique(temp_ph_data$Sample_date))+
   guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
   theme(legend.position = 'none',
         panel.grid.minor = element_blank()))
```

```{r PH plot, echo = FALSE, fig.align='center'}
#Circles = control, square = low, triangle = high
(pH_figure = 
    ggplot(data = temp_pd_dat_avg, 
           aes(x = Sample_date, y = pH_treat_avg, 
               group = Treatment, shape = Treatment, fill = Treatment, color = Treatment)) +
    geom_vline(xintercept = 3, linetype = "dashed", color = "black") +
    geom_line(aes(x = Sample_date, y = pH_treat_avg, group = Treatment)) +
    geom_errorbar(aes(ymin = pH_treat_avg - pH_treat_se, ymax = pH_treat_avg + pH_treat_se),
                  position = position_dodge(0.2),
                  width = 0.2) +
    geom_jitter(data = temp_ph_data, aes(x = Sample_date, y = pH_avg, 
                                                 group = Treatment, fill = Treatment),
                position = position_jitter(0.15),
                alpha = 0.3,
                size = 2) +
    geom_point(aes(shape = Treatment, fill = Treatment),
               position = position_dodge(0.2),
               size = 4) +
    labs(y = 'pH', 
         x = 'Sampling period') +
    theme_bw() +
    scale_color_manual(values = c(Johnson[1], Johnson[2], Johnson[3])) +
    scale_x_continuous(breaks = unique(temp_ph_data$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

## 7.3. Dissolved oxygen & respiration

```{r DO: data processing, echo = FALSE}
#Now I am going to get the treatment means and se's in a separate dataframe for plotting purposes
DO_dat_avg <- 
  DO_CR_data %>%
  group_by(Treatment, Stage, Sample_date) %>%
  reframe(
    DO_mgL_treat_avg = mean(Morning_DO_mgL, na.rm = T),
    DO_mgL_treat_se = sd(Morning_DO_mgL, na.rm = T)/sqrt(n()),
    DO_perc_treat_avg = mean(Morning_DO_perc, na.rm = T),
    DO_perc_treat_se = sd(Morning_DO_perc, na.rm = T)/sqrt(n()),
    CR_mgL_treat_avg = mean(CR_DO_mgL, na.rm = T),
    CR_mgL_treat_se = sd(CR_DO_mgL, na.rm = T)/sqrt(n()),
    CR_perc_treat_avg = mean(CR_DO_perc, na.rm = T),
    CR_perc_treat_se = sd(CR_DO_perc, na.rm = T)/sqrt(n()))

#I'm also going to create a long format of the dataset so that time of day has its own column
DO_CR_data_long <- 
  DO_CR_data %>% 
  gather(key = 'Time_of_day', value = "DO_value", Morning_DO_mgL:Sunset_DO_perc) %>% 
  separate(Time_of_day, into = c("Time_of_day", "DO_type"), sep = "_DO_") %>% 
  spread(key = DO_type, value = DO_value) %>% 
  rename('DO_mgL' = mgL,
         'DO_perc' = perc)

DO_only_data <- 
  DO_CR_data_long %>% 
  select(-CR_DO_mgL, -CR_DO_perc)
  
AR_only_data <- 
  DO_CR_data_long %>% 
  select(-Time_of_day, -DO_mgL, -DO_perc) %>% 
  distinct()
```

```{r DO:  histograms, fig.align='center'}
#histogram of DO
DO_only_data  %>% 
  ggplot(aes(x = DO_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_bw()

#histogram CR
AR_only_data %>% 
  ggplot(aes(x = CR_DO_mgL)) +
  geom_histogram(color = 'black', fill = 'goldenrod') +
  theme_classic()
```

```{r DO summary stats TABLE, echo = FALSE, include = FALSE}
DO_morning.sum.stats = summary_stats(DO_CR_data_long, "DO_mgL", c("Stage", "Treatment", "Time_of_day")) %>% 
  filter(Time_of_day == 'Morning')

DO_perc_morning.sum.stats = summary_stats(DO_CR_data_long, "DO_perc", c("Stage", "Treatment", "Time_of_day")) %>% 
  filter(Time_of_day == 'Morning')

AR_mgl.sum.stats = summary_stats(DO_CR_data_long, 
                     "CR_DO_mgL", c("Stage", "Treatment"))
AR_perc.sum.stats = summary_stats(DO_CR_data_long, 
                                  "CR_DO_perc", c("Stage", "Treatment"))

#use flextable to create a table in a word document
#DO mgL - morning measurments
DO_morning.sum.stats = 
  DO_morning.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE, -Sample_Size, -Min, -Max, -Time_of_day)

(DO_morning_table = 
    qflextable(DO_morning.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(DO_morning_table, path = paste0(table_path, "DO_morning_table.docx"))

#DO % - morning measurments
DO_perc_morning.sum.stats = 
  DO_perc_morning.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE, -Sample_Size, -Min, -Max, -Time_of_day)

(DO_perc_morning_table = 
    qflextable(DO_perc_morning.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(DO_perc_morning_table, 
             path = paste0(table_path, "DO_perc_morning_table.docx"))

#Aerobic respiration
##mgl
AR_mgl.sum.stats = 
  AR_mgl.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE)

(AR_mgl_morning_table = 
    qflextable(AR_mgl.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(AR_mgl_morning_table, 
             path = paste0(table_path, "AR_mgl_morning_table.docx"))

##perc
AR_perc.sum.stats = 
  AR_perc.sum.stats %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-SE, -Sample_Size, -Min, -Max)

(AR_perc_morning_table = 
    qflextable(AR_perc.sum.stats) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header'))  #change row 2 and column 1 

save_as_docx(AR_perc_morning_table, 
             path = paste0(table_path, "AR_perc_morning_table.docx"))

```

###7.1.1 Aerobic respiration

```{r DO AR: modelling, echo = FALSE, cache = TRUE}
#set the model structure
DO_AR.bf = 
  bf(CR_DO_mgL ~ 1 + Stage*Treatment + Sample_date +(1|Mesocosm))

#set prior
gaus.prior = 
  prior = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("normal(0, 1)", class = "b"),
    set_prior("exponential(1)", class = 'sd'))

#run model
DO_AR_gaus.model = 
  brm(
    DO_AR.bf, 
    data = AR_only_data, 
    cores = 4, chains = 4, warmup = 1000, iter = 2000,
    seed = 1222, 
    family = gaussian(),
    prior = gaus.prior,
    save_pars = save_pars(all = TRUE),
    file = paste0(model_path, 'DO_AR_gaus.model'),
    file_refit = getOption(paste0(model_path, 'DO_AR_gaus.model'), 'on_change'),
    control = list(adapt_delta = 0.99))

#posterior predictive check
pp_check(DO_AR_gaus.model, ndraws = 100) #looks okay

#summary of full model 
summary(DO_AR_gaus.model, prob = 0.95)

#Conditional effects neg binom
DO_AR_cond_eff = plot(conditional_effects(DO_AR_gaus.model), plot = F)
DO_AR_cond_eff$Treatment
DO_AR_cond_eff$Stage
DO_AR_cond_eff$Sample_date
DO_AR_cond_eff$`Stage:Treatment`

#add waic and loo ARiterion 
DO_AR_gaus.model <- 
  add_ARiterion(
    DO_AR_gaus.model, c('waic', 'loo'), moment_match = T, overwrite = T, 
    file = paste0(model_path, 'DO_AR_gaus.model.model'))

```

```{r DO_AR: model coefficients TABLE, include = FALSE, echo = FALSE}
#extract summary table from brms
DO_AR_b_params <- 
  summary(DO_AR_gaus.model, prob = 0.95)$fixed 

(DO_AR_b_params <- 
    rownames_to_column(DO_AR_b_params, "Parameters") %>% 
    mutate_if(is.numeric, round, 4) %>% 
    dplyr::select(-Rhat, -Bulk_ESS, -Tail_ESS))

#use flextable to AReate a table in a word document  
(DO_AR_model_table = 
    qflextable(DO_AR_b_params) %>% 
    fontsize(part = "all", size = 11) %>% 
    bold(part = 'header')  %>% 
    flextable::compose(i = 2, j = 1, as_paragraph(as_chunk('Stage (Fish intro)'))) %>% 
    flextable::compose(i = 3, j = 1, as_paragraph(as_chunk('Stage (Flx intro)'))) %>% 
    flextable::compose(i = 4, j = 1, as_paragraph(as_chunk('Stage (Fish removal)'))) %>% 
    flextable::compose(i = 5, j = 1, as_paragraph(as_chunk('Treatment (Low)'))) %>% 
    flextable::compose(i = 6, j = 1, as_paragraph(as_chunk('Treatment (High)'))) %>% 
    flextable::compose(i = 7, j = 1, as_paragraph(as_chunk('Sample week'))) %>% 
    flextable::compose(i = 8, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 9, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (Low)'))) %>% 
    flextable::compose(i = 10, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (Low)'))) %>%
    flextable::compose(i = 11, j = 1, as_paragraph(as_chunk('Stage (Fish intro): Treatment (High)'))) %>% 
    flextable::compose(i = 12, j = 1, as_paragraph(as_chunk('Stage (Flx intro): Treatment (High)'))) %>% 
    flextable::compose(i = 13, j = 1, as_paragraph(as_chunk('Stage (Fish removal): Treatment (High)'))))

save_as_docx(DO_AR_model_table, 
             path = paste0(table_path, "DO_AR_model_table.docx"))
```

```{r DO_AR: planned comparisons - emmeans, echo = FALSE}
#Differences between stages for each treatment
#Estimated (or predicted) means from models
(DO_AR.stage.emm <- emmeans(DO_AR_gaus.model, ~ Stage|Treatment, type = 'response'))

(DO_AR.stage.cont = 
  as.data.frame(
    contrast(DO_AR.stage.emm, 
             list('Establishment vs. Fish only' = c(-1, 1, 0, 0),
                  'Fish only vs. Fish & Flx ' = c(0, -1, 1, 0),
                  'Fish & Flx vs. Flx only ' = c(0,0, -1, 1),
                  'Fish vs. ALL' = c(0, -1, 1/2, 1/2)))))

(DO_AR.stage.emm_filt <- as.data.frame(DO_AR.stage.emm) %>% 
  filter(!Stage == 'Exposure only') %>% 
  select(emmean))  

#need to add the values for Fish only stage again, for final contrast calculation
(replicate_rows <- DO_AR.stage.emm_filt %>%
  filter(row_number() %in% c(2,5,8)))

(DO_AR.stage.emm_filt <- rbind(DO_AR.stage.emm_filt, replicate_rows))

#Need to swap rows for calculation to work
(DO_AR.stage.emm_filt <- DO_AR.stage.emm_filt %>% 
  slice(c(1:3,10,4:6,11,7:9,12)))

#combine
(DO_AR.stage.cont_sum <- 
  cbind(DO_AR.stage.cont, DO_AR.stage.emm_filt))

(DO_AR.stage.cont_sum <-  
  DO_AR.stage.cont_sum %>% 
  #rescale back to normal values
  #mutate(aARoss(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))
  
#Difference between treatments at each stage
(DO_AR_treat.emm <- emmeans(DO_AR_gaus.model, ~ Treatment|Stage))
(DO_AR.treat.cont <- 
  as.data.frame(
  contrast(
    DO_AR_treat.emm, 
    list('Control vs. Low' = c(-1, 1, 0),
         'Control vs. High' = c(-1, 0, 1),
         'Low vs. High' = c(0, -1, 1)))))

(DO_AR_treat.emm_filt <- as.data.frame(DO_AR_treat.emm)  %>% 
  select(emmean))

(DO_AR.treat.cont <- 
  cbind(DO_AR.treat.cont, DO_AR_treat.emm_filt))

(DO_AR.treat.cont <-  
  DO_AR.treat.cont %>% 
  #rescale back to normal values
  #mutate(aARoss(estimate:emmean, ~ .x * sd_chl_a + mean_chl_a)) %>% 
  mutate(percent_change = estimate/emmean * 100,
         l_perc_change = lower.HPD/emmean * 100,
         u_perc_change = upper.HPD/emmean * 100))
```

```{r DO_AR stage contrasts model predictions, echo = FALSE}
#Establishment
estab_DO_AR_draws <- DO_AR_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Establishment',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
  contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#Fish only
fish_DO_AR_draws <- DO_AR_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish only',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Fish_exposure
fish_exp_DO_AR_draws <- DO_AR_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Fish_Exposure',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()


#Exposure
exp_DO_AR_draws <- DO_AR_gaus.model %>% 
  emmeans( ~ Treatment,
           at = list(Stage = 'Exposure only',
                     Sample_date = 4,
                     Mesocosm = 'T1'),
           epred = TRUE) %>% 
   contrast(list('Control - Low' = c(1, -1, 0),
                'Control - High' = c(1, 0, -1),
                'Low - High' = c(0, 1, -1))) %>% 
  gather_emmeans_draws()

#combined
DO_AR_stage_draws <- 
  rbind(
    cbind(estab_DO_AR_draws, 
          data.frame(Stage = 'Establishment')),
    cbind(fish_DO_AR_draws, 
          data.frame(Stage = 'Mosquitofish introduction')),
    cbind(fish_exp_DO_AR_draws, 
          data.frame(Stage = 'Fluoxetine introduction')),
    cbind(exp_DO_AR_draws, 
          data.frame(Stage = 'Post-mosquitofish removal')))


DO_AR_stage_draws$Stage <- 
  factor(DO_AR_stage_draws$Stage,
         levels = c('Establishment',
                    'Mosquitofish introduction',
                    'Fluoxetine introduction',
                    'Post-mosquitofish removal'))

DO_AR_stage_draws$contrast <- factor(DO_AR_stage_draws$contrast,
                                 levels = c('Low - High',
                                            'Control - High',
                                            'Control - Low'))

DO_AR_stage_draws %>% 
  group_by(Stage, contrast) %>% 
  mean_hdi()


#plot
(DO_AR_stage_marg_fig <- 
    ggplot(DO_AR_stage_draws, 
           aes(x = .value, y = contrast, fill = contrast)) +
    stat_pointinterval(aes(fill = contrast), 
                       .width = c(0.95), 
                       size = 2,
                       point_interval = 'mean_hdi') +
    labs(x = "Difference in median marginal effects", 
         y = '') +
    geom_vline(xintercept = 0, 
               linetype = 'dashed') +
    scale_fill_okabe_ito(alpha = 0.5) + 
    facet_wrap(vars(Stage)) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          axis.title = element_blank(),
          strip.background = element_rect(fill = 'grey')))
```

```{r DO_AR marginal effects FIGURE, include = FALSE}
ggsave(
  filename = paste0(figure_path, "DO_AR_stage_marg_fig.pdf"), 
  width = 210,
  height = 150,
  units = 'mm',
  device = 'pdf')
```

```{r AR (DO mgL) plot, echo = FALSE, fig.align='center'}
#AReate a dataset for plotting purposes
DO_AR_fig_dat <- 
  summary_stats(DO_AR_data_long, "AR_DO_mgL", c("Stage", "Treatment", "Sample_date"))

(AR_DO_mgl_figure = 
    ggplot(data = DO_AR_fig_dat, 
           aes(x = Sample_date, y = Mean, 
               group = Treatment, shape = Treatment)) +
    #geom_vline(xintercept = 3, linetype = "dashed", color = "black") +
    geom_line(
      aes(linetype = Treatment),
      position = position_dodge(0.3),
      lwd = 0.75) +
    geom_errorbar(
      aes(ymin = Mean - SE, 
          ymax = Mean + SE),
      position = position_dodge(0.3),
      width = 0.3) +
    # #geom_jitter(data = water_param_dat_filt, aes(x = Sample_date, y = pH, 
    #                                              group = Treatment, fill = Treatment),
    #             position = position_jitter(0.15),
    #             alpha = 0.3,
    #             size = 2) +
    geom_point(aes(shape = Treatment),
               position = position_dodge(0.3),
               size = 3,
               fill = 'white',
               color = 'black') +
    labs(y = 'Aerobic respiration (mg/L)', 
         x = 'Week') +
    theme_classic() +
    scale_shape_manual(values = c(21, 22, 24))+
    scale_linetype_manual(values = c(1,3,5)) +
    scale_x_continuous(breaks = unique(DO_AR_data_long$Sample_date))+
    guides(shape = guide_legend(override.aes = list(fill = 'white', color = 'black'))) +
    theme(legend.position = 'none',
          panel.grid.minor = element_blank()))
```

```{r DO_AR MS FIGURE, include = FALSE}
(DO_AR_figs <- AR_DO_mgl_figure + DO_AR_stage_marg_fig +
   plot_layout(widths = c(1,1)))

ggsave(
  filename = paste0(figure_path, "DO_AR_figs.pdf"), 
  width = 210,
  height = 85,
  units = 'mm',
  device = 'pdf')
```

